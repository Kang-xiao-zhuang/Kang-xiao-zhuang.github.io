<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ActiveMQ学习笔记 | 康小庄的博客</title><meta name="keywords" content="ActiveMQ"><meta name="author" content="康小庄"><meta name="copyright" content="康小庄"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="ActiveMQ学习笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="ActiveMQ学习笔记">
<meta property="og:url" content="http://example.com/2021/03/05/ActiveMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="康小庄的博客">
<meta property="og:description" content="ActiveMQ学习笔记">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://pic.imgdb.cn/item/60cda4a1844ef46bb2083fc5.png">
<meta property="article:published_time" content="2021-03-05T08:38:03.000Z">
<meta property="article:modified_time" content="2021-06-19T08:04:10.737Z">
<meta property="article:author" content="康小庄">
<meta property="article:tag" content="学习笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic.imgdb.cn/item/60cda4a1844ef46bb2083fc5.png"><link rel="shortcut icon" href="/img/2.png"><link rel="canonical" href="http://example.com/2021/03/05/ActiveMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: {"limitDay":180,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"top-right"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ActiveMQ学习笔记',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-06-19 16:04:10'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><link rel="stylesheet" href="/css/iconfont.css"><link rel="stylesheet" href="/css/customer_zk.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-butterfly-clock/lib/clock.min.css"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/1.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">51</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">10</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 目录</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw far fa-image"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline"><i class="fa-fw fas fa-link"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://pic.imgdb.cn/item/60cda4a1844ef46bb2083fc5.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">康小庄的博客</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 目录</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw far fa-image"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline"><i class="fa-fw fas fa-link"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ActiveMQ学习笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-03-05T08:38:03.000Z" title="发表于 2021-03-05 16:38:03">2021-03-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-06-19T08:04:10.737Z" title="更新于 2021-06-19 16:04:10">2021-06-19</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">11.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>50分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="ActiveMQ学习笔记"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="ActiveMQ学习笔记"><a href="#ActiveMQ学习笔记" class="headerlink" title="ActiveMQ学习笔记"></a>ActiveMQ学习笔记</h1><h2 id="1-ActiveMQ入门"><a href="#1-ActiveMQ入门" class="headerlink" title="1.ActiveMQ入门"></a>1.ActiveMQ入门</h2><h3 id="消息中间件应用场景"><a href="#消息中间件应用场景" class="headerlink" title="消息中间件应用场景"></a>消息中间件应用场景</h3><ul>
<li>异步处理</li>
<li>应用解耦</li>
<li>流量削峰</li>
</ul>
<h4 id="异步处理"><a href="#异步处理" class="headerlink" title="异步处理"></a>异步处理</h4><p>场景说明：用户注册，需要执行三个业务逻辑，分别为写入用户表，发注册邮件以及注册短信。</p>
<ul>
<li>串行方式<ul>
<li>将注册信息写入数据库成功后，发送注册邮件，再发送注册短信。以上三个任务全部完成后，返回给客户端。</li>
</ul>
</li>
</ul>
<p><img src="https://gitee.com/zhuang-kang/note-picture/raw/master/ActiveMQ%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/image-20210313141459082.png" alt="image-20210313141459082"></p>
<ul>
<li>并行方式<ul>
<li>将注册信息写入数据库成功后，发送注册邮件的同时，发送注册短信。以上三个任务完成后，返回给客户端。与串行的差别是，并行的方式可以提高处理的时间</li>
</ul>
</li>
</ul>
<p><img src="https://gitee.com/zhuang-kang/note-picture/raw/master/ActiveMQ%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/image-20210313141527875.png" alt="image-20210313141527875"></p>
<ul>
<li>异步处理<ul>
<li>引入消息中间件，将部分的业务逻辑，进行异步处理。改造后的架构如下：</li>
</ul>
</li>
</ul>
<p><img src="https://gitee.com/zhuang-kang/note-picture/raw/master/ActiveMQ%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/image-20210313141604405.png" alt="image-20210313141604405"></p>
<p><strong>按照以上约定，用户的响应时间相当于是注册信息写入数据库的时间，也就是 50毫秒。注册邮件，发送短信写入消息队列后，直接返回，因此写入消息队列的速度很快，基本可以忽略，因此用户的响应时间可能是50毫秒。因此架构改变后，系统的吞吐量提高啦，比串行提高了3倍，比并行提高了两倍。</strong></p>
<h4 id="应用解耦"><a href="#应用解耦" class="headerlink" title="应用解耦"></a>应用解耦</h4><p>场景说明：用户下单后，订单系统需要通知库存系统。<br>传统的做法是，订单系统调用库存系统的接口。如下图：</p>
<p><img src="https://gitee.com/zhuang-kang/note-picture/raw/master/ActiveMQ%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/image-20210313141811536.png" alt="image-20210313141811536"></p>
<p><strong>传统模式的缺点：</strong>假如库存系统无法访问，则订单减库存将失败，从而导致订单失败，订单系统与库存系统耦合。</p>
<p>如何解决以上问题呢？引入应用消息队列后的方案，如下图：</p>
<p><img src="https://gitee.com/zhuang-kang/note-picture/raw/master/ActiveMQ%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/image-20210313141848639.png" alt="image-20210313141848639"></p>
<p><strong>订单系统：用户下单后，订单系统完成持久化处理，将消息写入消息队列，返回用户订单下单成功 库存系统：订阅下单的消息，采用拉/推的方式，获取下单信息，库存系统根据下单信息，进行库存操作 假如：在下单时库存系统不能正常使用。也不影响正常下单，因为下单后，订单系统写入消息队列就不再关心其他的后续操作了。实现订单系统与库存系统的应用解耦。</strong></p>
<h4 id="流量削峰"><a href="#流量削峰" class="headerlink" title="流量削峰"></a>流量削峰</h4><p>流量削锋也是消息队列中的常用场景，一般在秒杀或团抢活动中使用广泛。应用场景：秒杀活动，一般会因为流量过大，导致流量暴增，应用挂掉。为解决这个问题，一般需要在应用前端加入消息队列。<br>通过加入消息队列完成如下功能：<br>a、可以控制活动的人数</p>
<p>b、可以缓解短时间内高流量压垮应用</p>
<p><img src="https://gitee.com/zhuang-kang/note-picture/raw/master/ActiveMQ%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/image-20210313142125812.png" alt="image-20210313142125812"></p>
<p><strong>用户的请求，服务器接收后，首先写入消息队列。假如消息队列长度超过最大数量，则直接抛弃用户请</strong><br><strong>求或跳转到错误页面。秒杀业务根据消息队列中的请求信息，再做后续处理</strong></p>
<p><strong>常见的消息中间件产品对比</strong></p>
<table>
<thead>
<tr>
<th>特性</th>
<th>ActiveMQ</th>
<th>RabbitMQ</th>
<th>RocketMQ</th>
<th>Kafka</th>
</tr>
</thead>
<tbody><tr>
<td>语言</td>
<td>Java</td>
<td>Erlang</td>
<td>Java</td>
<td>Scala</td>
</tr>
<tr>
<td>单击吞吐量</td>
<td>万级</td>
<td>万级</td>
<td>10万级</td>
<td>10万级</td>
</tr>
<tr>
<td>时效性</td>
<td>毫秒级</td>
<td>微秒级</td>
<td>毫秒级</td>
<td>毫秒级</td>
</tr>
<tr>
<td>可用性</td>
<td>高</td>
<td>高</td>
<td>分布式架构 高</td>
<td>分布式架构 高</td>
</tr>
<tr>
<td>功能性</td>
<td>成熟，公司得到应用</td>
<td>并发能力强，管理界面比较丰富</td>
<td>功能完备，扩展性好</td>
<td>大数据应用逛</td>
</tr>
</tbody></table>
<h3 id="ActiveMQ简介及JMS"><a href="#ActiveMQ简介及JMS" class="headerlink" title="ActiveMQ简介及JMS"></a>ActiveMQ简介及JMS</h3><p><img src="https://gitee.com/zhuang-kang/note-picture/raw/master/ActiveMQ%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/image-20210313142739222.png" alt="image-20210313142739222"></p>
<p><strong>官网<a target="_blank" rel="noopener" href="http://activemq.apache.org/">http://activemq.apache.org/</a></strong></p>
<ul>
<li><p><strong>什么是AcitveMQ</strong></p>
<ul>
<li>ActiveMQ 是Apache出品，最流行的，能力强劲的开源消息总线。</li>
<li>ActiveMQ 是一个完全支持JMS1.1和J2EE 1.4规范的 JMS Provider实现。</li>
</ul>
</li>
<li><p>什么是JMS</p>
</li>
</ul>
<p>消息中间件利用高效可靠的消息传递机制进行平台无关的数据交流，并基于数据通信来进行分布式系统<br>的集成。它可以在分布式环境下扩展进程间的通信。对于消息中间件，常见的角色大致也就有<br><strong>Producer（生产者）、Consumer（消费者）。</strong></p>
<p>消息队列中间件是分布式系统中重要的组件，主要解决<strong>应用解耦，异步消息，流量削锋</strong>等问题，实现<strong>高</strong><br><strong>性能，高可用，可伸缩和最终一致性</strong>架构。</p>
<p>JMS（ Java Messaging Service）是Java平台上有<strong>关面向消息中间件的技术规范</strong>，它便于消息系统中的<br>Java应用程序进行消息交换,并且通过<strong>提供标准的产生、发送、接收消息的接口简化企业应用的开发</strong>。</p>
<p>JMS本身<strong>只定义了一系列的接口规范</strong>，是一种与厂商无关的 API，<strong>用来访问消息收发系统</strong>。它类似于<br>JDBC(java Database Connectivity)：这里，JDBC 是可以用来访问许多不同关系数据库 的 API，而 JMS<br>则提供同样与厂商无关的访问方法，以访问消息收发服务。许多厂商目前都支持 JMS，包括 IBM 的<br>MQSeries、BEA的 Weblogic JMS service和 Progress 的 SonicMQ，这只是几个例子。 <strong>JMS 使您能够</strong><br><strong>通过消息收发服务（有时称为消息中介程序或路由器）从一个 JMS 客户机向另一个 JML 客户机发送消</strong><br><strong>息</strong>。消息是 JMS 中的一种类型对象，由两部分组成：<strong>报头和消息主体</strong>。报头由路由信息以及有关该消息<br>的元数据组成。<strong>消息主体则携带着应用程序的数据或有效负载</strong>。</p>
<h4 id="JMS消息模型"><a href="#JMS消息模型" class="headerlink" title="JMS消息模型"></a>JMS消息模型</h4><p>消息中间件一般有两种传递模式：<strong>点对点模式(P2P)和发布-订阅模式(Pub/Sub)。</strong></p>
<ul>
<li>(1) P2P (Point to Point) 点对点模型（Queue队列模型）</li>
<li>(2) Publish/Subscribe(Pub/Sub) 发布/订阅模型(Topic主题模型)点对点模型</li>
</ul>
<blockquote>
<p><strong>点对点模型（ Pointer-to-Pointer）：即生产者和消费者之间的消息往来。</strong></p>
</blockquote>
<p><img src="https://gitee.com/zhuang-kang/note-picture/raw/master/ActiveMQ%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/image-20210313143155106.png" alt="image-20210313143155106"></p>
<p>每个消息都被发送到特定的消息队列，接收者从队列中获取消息。队列保留着消息，直到他们被消费或超时。</p>
<h5 id="点对点模型的特点"><a href="#点对点模型的特点" class="headerlink" title="点对点模型的特点"></a><strong>点对点模型的特点</strong></h5><ul>
<li>每个消息只有一个消费者（ Consumer）(即一旦被消费，消息就不再在消息队列中)；</li>
<li>发送者和接收者之间在时间上没有依赖性，也就是说当发送者发送了消息之后，不管接收者有没有正在运行，它不会影响到消息被发送到队列；</li>
<li>接收者在成功接收消息之后需向队列应答成功。</li>
</ul>
<p><strong>举例</strong></p>
<p><img src="https://gitee.com/zhuang-kang/note-picture/raw/master/ActiveMQ%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/image-20210313143350809.png" alt="image-20210313143350809"></p>
<h5 id="发布-订阅模型"><a href="#发布-订阅模型" class="headerlink" title="发布/订阅模型"></a>发布/订阅模型</h5><blockquote>
<p>发布/订阅（Publish-Subscribe）</p>
</blockquote>
<p>包含三个角色：<strong>主题（Topic），发布者（Publisher），订阅者（Subscriber）</strong>，多个发布者将消息发送到topic，系统将这些消息投递到订阅此topic的订阅者</p>
<p><img src="https://gitee.com/zhuang-kang/note-picture/raw/master/ActiveMQ%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/image-20210313143516023.png" alt="image-20210313143516023"></p>
<p>发布者发送到 topic的消息，只有订阅了topic的订阅者才会收到消息。topic实现了发布和订阅，当你发布一个消息，所有订阅这个topic的服务都能得到这个消息，所以从1到N个订阅者都能得到这个消息的拷贝</p>
<p><strong>发布/订阅模型的特点</strong></p>
<ul>
<li>每个消息可以有多个消费者</li>
<li>发布者和订阅者之间有时间上的依赖性（先订阅主题，再来发送消息）</li>
<li>订阅者必须保持运行的状态，才能接受发布者发布的消息</li>
</ul>
<h4 id="JMS编程API"><a href="#JMS编程API" class="headerlink" title="JMS编程API"></a>JMS编程API</h4><table>
<thead>
<tr>
<th>要素</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>Destination</td>
<td>用来定义消息从发送端发出后要走的通道，而不是接收方。Destination属于管理类对象</td>
</tr>
<tr>
<td>ConnectionFactory</td>
<td>用于创建连接对象</td>
</tr>
<tr>
<td>Connection</td>
<td>连接接口，所负责的重要工作时创建Session</td>
</tr>
<tr>
<td>Session</td>
<td>会话接口，这是一个非常重要的对象，消息发送者、消息接收者以及消息对象本身，都是通过这个会话对象创建的</td>
</tr>
<tr>
<td>MessageConsumer</td>
<td>消息的消费者，也就是订阅消息并处理消息的对象</td>
</tr>
<tr>
<td>MessageProducer</td>
<td>消息的生产者，也就是用来发送消息的对象</td>
</tr>
</tbody></table>
<h5 id="1）ConnectionFactory"><a href="#1）ConnectionFactory" class="headerlink" title="(1）ConnectionFactory"></a>(1）ConnectionFactory</h5><p>创建Connection对象的工厂，针对两种不同的jms消息模型，分别有QueueConnectionFactory和TopicConnectionFactory两种。</p>
<h5 id="2）Destination"><a href="#2）Destination" class="headerlink" title="(2）Destination"></a>(2）Destination</h5><p>Destination的意思是消息生产者的消息发送目标或者说消息消费者的消息来源。对于消息生产者来说，它的Destination是某个队列（Queue）或某个主题（Topic）;对于消息消费者来说，它的Destination也是某个队列或主题（即消息来源）。所以，Destination实际上就是两种类型的对象：<strong>Queue、Topic</strong></p>
<h5 id="3）Connection"><a href="#3）Connection" class="headerlink" title="(3）Connection"></a>(3）Connection</h5><p>Connection表示在客户端和JMS系统之间建立的链接（对TCP/IP socket的包装）。<strong>Connection可以产生一个或多个Session</strong></p>
<h5 id="4）Session"><a href="#4）Session" class="headerlink" title="(4）Session"></a>(4）Session</h5><p>Session 是我们对消息进行操作的接口，可以通过session<strong>创建生产者、消费者、消息</strong>等。Session 提供了事务的功能，如果需要使用session发送/接收多个消息时，可以将这些发送/接收动作放到一个事务中。</p>
<h5 id="5）Producter"><a href="#5）Producter" class="headerlink" title="(5）Producter"></a>(5）Producter</h5><p>Producter（消息生产者）：<strong>消息生产者由Session创建</strong>，并用于将消息发送到Destination。同样，消息生产者分两种类型：<strong>QueueSender和TopicPublisher</strong>。可以调用消息生产者的方法（send或publish方法）发送消息。</p>
<h5 id="6）Consumer"><a href="#6）Consumer" class="headerlink" title="(6）Consumer"></a>(6）Consumer</h5><p>Consumer （消息消费者）：<strong>消息消费者由Session创建</strong>，用于接收被发送到Destination的消息。两种类型：<strong>QueueReceiver和TopicSubscriber</strong>。可分别通过<strong>session的createReceiver(Queue)或createSubscriber(Topic)来创建</strong>。当然，也可以session的creatDurableSubscriber方法来创建持久化的订阅者。</p>
<h5 id="7）MessageListener"><a href="#7）MessageListener" class="headerlink" title="(7）MessageListener"></a>(7）MessageListener</h5><p>消息监听器。<strong>如果注册了消息监听器，一旦消息到达，将自动调用监听器的onMessage方法</strong>。EJB中的MDB（Message-Driven Bean）就是一种MessageListener。</p>
<p><img src="https://gitee.com/zhuang-kang/note-picture/raw/master/ActiveMQ%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/image-20210313144419878.png" alt="image-20210313144419878"></p>
<h2 id="2-ActiveMQ安装"><a href="#2-ActiveMQ安装" class="headerlink" title="2.ActiveMQ安装"></a>2.ActiveMQ安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">第一步：安装 jdk（略）</span><br><span class="line">第二步：把 activemq的压缩包（apache-activemq-5.14.5-bin.tar.gz）上传到 linux 系统</span><br><span class="line">第三步：解压缩压缩包 </span><br><span class="line"><span class="meta">$</span><span class="bash"> tar -zxvf apache-activemq-5.14.5-bin.tar.gz</span></span><br><span class="line">第四步：进入apache-activemq-5.14.5的bin目录</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> apache-activemq-5.14.5/bin</span></span><br><span class="line">第五步：启动 activemq</span><br><span class="line"><span class="meta">$</span><span class="bash"> ./activemq start (执行2次：第一次：生成配置信息；第二次：启动)</span></span><br><span class="line">第六步：停止activemq：</span><br><span class="line"><span class="meta">$</span><span class="bash"> ./activemq stop</span></span><br></pre></td></tr></table></figure>

<p><strong>测试连接</strong></p>
<p><strong>浏览器输入：linuxip:8161</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">页面控制台： http://ip:8161 (监控)</span><br><span class="line">请求地址：  tcp://ip:61616 （java代码访问消息中间件）</span><br></pre></td></tr></table></figure>

<p>账号： admin<br>密码：admin</p>
<p><img src="https://gitee.com/zhuang-kang/note-picture/raw/master/ActiveMQ%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/image-20210313144724034.png" alt="image-20210313144724034"></p>
<p><img src="https://gitee.com/zhuang-kang/note-picture/raw/master/ActiveMQ%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/image-20210313144736828.png" alt="image-20210313144736828"></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">列表各列信息含义如下：</span><br><span class="line">Number Of Pending Messages ：等待消费的消息 这个是当前未出队列的数量。</span><br><span class="line">Number Of Consumers ：消费者 这个是消费者端的消费者数量</span><br><span class="line">Messages Enqueued ：进入队列的消息 进入队列的总数量,包括出队列的。</span><br><span class="line">Messages Dequeued ：出了队列的消息 可以理解为是消费这消费掉的数量。</span><br></pre></td></tr></table></figure>

<h2 id="3-原生TMS-API操作ActiveMQ"><a href="#3-原生TMS-API操作ActiveMQ" class="headerlink" title="3.原生TMS API操作ActiveMQ"></a>3.原生TMS API操作ActiveMQ</h2><h3 id="PTP-模式-生产者"><a href="#PTP-模式-生产者" class="headerlink" title="PTP 模式(生产者)"></a>PTP 模式(生产者)</h3><p> <strong>（1）引入坐标</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.activemq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activemq-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.11.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>步骤：</strong></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1.创建连接工厂</span><br><span class="line">2.创建连接</span><br><span class="line">3.打开连接</span><br><span class="line">4.创建session</span><br><span class="line">5.创建目标地址（Queue:点对点消息，Topic：发布订阅消息）</span><br><span class="line">6.创建消息生产者</span><br><span class="line">7.创建消息</span><br><span class="line">8.发送消息</span><br><span class="line">9.释放资源</span><br></pre></td></tr></table></figure>



<p><strong>（ 2）编写生产消息的测试类 QueueProducer</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PTP_Producer</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> JMSException </span>&#123;</span><br><span class="line">    <span class="comment">//1.创建连接工厂</span></span><br><span class="line">    ConnectionFactory factory= <span class="keyword">new</span> ActiveMQConnectionFactory(<span class="string">&quot;tcp://linuxip:61616&quot;</span>);</span><br><span class="line">    <span class="comment">//2.创建连接</span></span><br><span class="line">    Connection connection = factory.createConnection();</span><br><span class="line">    <span class="comment">//3.打开连接</span></span><br><span class="line">    connection.start();</span><br><span class="line">    <span class="comment">//4.创建session</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 参数一：是否开启事务操作</span></span><br><span class="line"><span class="comment">	观察发送消息的结果：</span></span><br><span class="line"><span class="comment">	PTP模式(消费者)</span></span><br><span class="line"><span class="comment">	步骤：</span></span><br><span class="line"><span class="comment">    * 参数二：消息确认机制</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    Session session = connection.createSession(<span class="keyword">false</span>,Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">    <span class="comment">//5.创建目标地址（Queue:点对点消息，Topic：发布订阅消息）</span></span><br><span class="line">    Queue queue = session.createQueue(<span class="string">&quot;queue01&quot;</span>);</span><br><span class="line">    <span class="comment">//6.创建消息生产者</span></span><br><span class="line">    MessageProducer producer = session.createProducer(queue);</span><br><span class="line">    <span class="comment">//7.创建消息</span></span><br><span class="line">    <span class="comment">//createTextMessage: 文本类型</span></span><br><span class="line">    TextMessage textMessage = session.createTextMessage(<span class="string">&quot;test message&quot;</span>);</span><br><span class="line">    <span class="comment">//8.发送消息</span></span><br><span class="line">    producer.send(textMessage);</span><br><span class="line">    System.out.println(<span class="string">&quot;消息发送完成&quot;</span>);</span><br><span class="line">    <span class="comment">//9.释放资源</span></span><br><span class="line">    session.close();</span><br><span class="line">    connection.close();</span><br><span class="line">	 &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>启动测试结果</strong></p>
<p><img src="https://gitee.com/zhuang-kang/note-picture/raw/master/ActiveMQ%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/image-20210313145341189.png" alt="image-20210313145341189"></p>
<h3 id="PTP模式-消费者"><a href="#PTP模式-消费者" class="headerlink" title="PTP模式(消费者)"></a>PTP模式(消费者)</h3><p><strong>步骤：</strong></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1.创建连接工厂</span><br><span class="line">2.创建连接</span><br><span class="line">3.打开连接</span><br><span class="line">4.创建session</span><br><span class="line">5.指定目标地址</span><br><span class="line">6.创建消息的消费者</span><br><span class="line">7.配置消息监听器</span><br></pre></td></tr></table></figure>

<p><strong>第一种写法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PTP_Consumer1</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> JMSException </span>&#123;</span><br><span class="line">    <span class="comment">//1.创建连接工厂</span></span><br><span class="line">    ConnectionFactory factory= <span class="keyword">new</span> ActiveMQConnectionFactory(<span class="string">&quot;tcp://linuxip:61616&quot;</span>);</span><br><span class="line">    <span class="comment">//2.创建连接</span></span><br><span class="line">    Connection connection = factory.createConnection();</span><br><span class="line">    <span class="comment">//3.打开连接</span></span><br><span class="line">    connection.start();</span><br><span class="line">    <span class="comment">//4.创建session</span></span><br><span class="line">    Session session = connection.createSession(<span class="keyword">false</span>,Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">    <span class="comment">//5.指定目标地址</span></span><br><span class="line">    Queue queue = session.createQueue(<span class="string">&quot;queue01&quot;</span>);</span><br><span class="line">    <span class="comment">//6.创建消息的消费者</span></span><br><span class="line">    MessageConsumer consumer = session.createConsumer(queue);</span><br><span class="line">    <span class="comment">//7.接收消息</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">      Message message = consumer.receive();</span><br><span class="line">      <span class="comment">//如果已经没有消息了，结束啦</span></span><br><span class="line">      <span class="keyword">if</span>(message==<span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">     &#125;</span><br><span class="line">      <span class="comment">//如果还有消息，判断什么类型的消息</span></span><br><span class="line">      <span class="keyword">if</span>(message <span class="keyword">instanceof</span> TextMessage)&#123;</span><br><span class="line">        TextMessage textMessage = (TextMessage)message;</span><br><span class="line">        System.out.println(<span class="string">&quot;接收的消息：&quot;</span>+textMessage.getText());</span><br><span class="line">   			  &#125;</span><br><span class="line">  	 	&#125;</span><br><span class="line"> 	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>第二种写法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PTP_Consumer2</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> JMSException </span>&#123;</span><br><span class="line">    <span class="comment">//1.创建连接工厂</span></span><br><span class="line">    ConnectionFactory factory= <span class="keyword">new</span> ActiveMQConnectionFactory(<span class="string">&quot;tcp://linuxip:61616&quot;</span>);</span><br><span class="line">    <span class="comment">//2.创建连接</span></span><br><span class="line">    Connection connection = factory.createConnection();</span><br><span class="line">    <span class="comment">//3.打开连接</span></span><br><span class="line">    connection.start();</span><br><span class="line">    <span class="comment">//4.创建session</span></span><br><span class="line">    Session session = connection.createSession(<span class="keyword">false</span>,Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">    <span class="comment">//5.指定目标地址</span></span><br><span class="line">    Queue queue = session.createQueue(<span class="string">&quot;queue01&quot;</span>);</span><br><span class="line">    <span class="comment">//6.创建消息的消费者</span></span><br><span class="line">    MessageConsumer consumer = session.createConsumer(queue);</span><br><span class="line">    <span class="comment">//7.设置消息监听器来接收消息</span></span><br><span class="line">    consumer.setMessageListener(<span class="keyword">new</span> MessageListener() &#123;</span><br><span class="line">      <span class="comment">//处理消息</span></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(message <span class="keyword">instanceof</span> TextMessage)&#123;</span><br><span class="line">          TextMessage textMessage = (TextMessage)message;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;接收的消息（2）：&quot;</span>+textMessage.getText());</span><br><span class="line">         &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;);</span><br><span class="line">    <span class="comment">//注意：在监听器的模式下千万不要关闭连接，一旦关闭，消息无法接收</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>启动测试</strong></p>
<p><img src="https://gitee.com/zhuang-kang/note-picture/raw/master/ActiveMQ%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/image-20210313145806568.png" alt="image-20210313145806568"></p>
<h3 id="Pub-Sub模式-生成者"><a href="#Pub-Sub模式-生成者" class="headerlink" title="Pub/Sub模式(生成者)"></a>Pub/Sub模式(生成者)</h3><p><strong>步骤：</strong></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1.创建连接工厂</span><br><span class="line">2.创建连接</span><br><span class="line">3.打开连接</span><br><span class="line">4.创建session</span><br><span class="line">5.创建目标地址（Queue:点对点消息，Topic：发布订阅消息）</span><br><span class="line">6.创建消息生产者</span><br><span class="line">7.创建消息</span><br><span class="line">8.发送消息</span><br><span class="line">9.释放资源</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TopicProducer</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">//1.创建连接工厂</span></span><br><span class="line">    ConnectionFactory factory = newActiveMQConnectionFactory(<span class="string">&quot;tcp://linuxip:61616&quot;</span>);</span><br><span class="line">    <span class="comment">//2.创建连接</span></span><br><span class="line">    Connection connection = factory.createConnection();</span><br><span class="line">    <span class="comment">//3.打开连接</span></span><br><span class="line">    connection.start();</span><br><span class="line">    <span class="comment">//4.创建session</span></span><br><span class="line">    Session session = connection.createSession(<span class="keyword">false</span>,Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">    <span class="comment">//5.创建目标地址（Queue:点对点消息，Topic：发布订阅消息）</span></span><br><span class="line">    Topic topic = session.createTopic(<span class="string">&quot;sms&quot;</span>);</span><br><span class="line">    <span class="comment">//6.创建消息生产者</span></span><br><span class="line">    MessageProducer producer = session.createProducer(topic);</span><br><span class="line">    <span class="comment">//7.创建消息</span></span><br><span class="line">    TextMessage message = session.createTextMessage(<span class="string">&quot;发短信...&quot;</span>);</span><br><span class="line">    <span class="comment">//8.发送消息</span></span><br><span class="line">    producer.send(message);</span><br><span class="line">    System.out.println(<span class="string">&quot;发送消息：发短信...&quot;</span>);</span><br><span class="line">    session.close();;</span><br><span class="line">    connection.close();</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/zhuang-kang/note-picture/raw/master/ActiveMQ%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/image-20210313150028026.png" alt="image-20210313150028026"></p>
<h3 id="Pub-Sub模式-消费者"><a href="#Pub-Sub模式-消费者" class="headerlink" title="Pub/Sub模式(消费者)"></a>Pub/Sub模式(消费者)</h3><p><strong>步骤：</strong></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1.创建连接工厂</span><br><span class="line">2.创建连接</span><br><span class="line">3.打开连接</span><br><span class="line">4.创建session</span><br><span class="line">5指定目标地址</span><br><span class="line">6.创建消息的消费者</span><br><span class="line">7.配置消息监听器</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TopicConsumer</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">//1.创建连接工厂</span></span><br><span class="line">    ConnectionFactory factory = newActiveMQConnectionFactory(<span class="string">&quot;tcp://linuxip:61616&quot;</span>);</span><br><span class="line">    <span class="comment">//2.创建连接</span></span><br><span class="line">    Connection connection = factory.createConnection();</span><br><span class="line">    <span class="comment">//3.打开连接</span></span><br><span class="line">    connection.start();</span><br><span class="line">    <span class="comment">//4.创建session</span></span><br><span class="line">    Session session = connection.createSession(<span class="keyword">false</span>,Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">    <span class="comment">//5.创建目标地址（Queue:点对点消息，Topic：发布订阅消息）</span></span><br><span class="line">    Topic topic = session.createTopic(<span class="string">&quot;sms&quot;</span>);</span><br><span class="line">    <span class="comment">//6.创建消息的消费者</span></span><br><span class="line">    MessageConsumer consumer = session.createConsumer(topic);</span><br><span class="line">    <span class="comment">//7.配置消息监听器</span></span><br><span class="line">    consumer.setMessageListener(<span class="keyword">new</span> MessageListener() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        TextMessage textMessage = (TextMessage) message;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          System.out.println(<span class="string">&quot;消费消息：&quot;</span> + textMessage.getText());</span><br><span class="line">       &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-Spring与ActiveMQ整合"><a href="#4-Spring与ActiveMQ整合" class="headerlink" title="4.Spring与ActiveMQ整合"></a>4.Spring与ActiveMQ整合</h2><h3 id="消息生产者"><a href="#消息生产者" class="headerlink" title="消息生产者"></a>消息生产者</h3><p><strong>1.导入坐标</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.activemq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activemq-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.11.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-oxm<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-tx<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context-support<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jms<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.jms<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.jms-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.xbean<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xbean-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>2 . 编写Spring整合ActiveMQ配置：applicationContext-producer.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:amp</span>=<span class="string">&quot;http://activemq.apache.org/schema/core&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">http://activemq.apache.org/schema/core</span></span></span><br><span class="line"><span class="tag"><span class="string">http://activemq.apache.org/schema/core/activemq-core.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--1.创建连接工厂对象--&gt;</span></span><br><span class="line">  &lt;amp:connectionFactory</span><br><span class="line">    id=&quot;connetionFactory&quot;</span><br><span class="line">    brokerURL=&quot;tcp://linuxip:61616&quot;</span><br><span class="line">    userName=&quot;admin&quot;</span><br><span class="line">    password=&quot;admin&quot;</span><br><span class="line">  /&gt;</span><br><span class="line">  <span class="comment">&lt;!--2.创建缓存连接工厂--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;cachingConnectionFactory&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">class</span>=<span class="string">&quot;org.springframework.jms.connection.CachingConnectionFactory&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--注入连接工厂--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;targetConnectionFactory&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;connetionFactory&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--缓存消息数据--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sessionCacheSize&quot;</span> <span class="attr">value</span>=<span class="string">&quot;5&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--3.创建用于点对点发送的JmsTemplate--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;jmsQueueTemplate&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">class</span>=<span class="string">&quot;org.springframework.jms.core.JmsTemplate&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--注入缓存连接工厂--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;connectionFactory&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;cachingConnectionFactory&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--指定是否为发布订阅模式--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;pubSubDomain&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--4.创建用于发布订阅发送的JmsTemplate--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;jmsTopicTemplate&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">class</span>=<span class="string">&quot;org.springframework.jms.core.JmsTemplate&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--注入缓存连接工厂--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;connectionFactory&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;cachingConnectionFactory&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--指定是否为发布订阅模式--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;pubSubDomain&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>3.编写测试类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span> <span class="comment">// junit与spring整合</span></span><br><span class="line"><span class="meta">@ContextConfiguration(&quot;classpath:applicationContext-producer.xml&quot;)</span> <span class="comment">// 加载spring配置文件</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringProducer</span> </span>&#123;</span><br><span class="line">  <span class="comment">//点对点模式</span></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="meta">@Qualifier(&quot;jmsQueueTemplate&quot;)</span></span><br><span class="line">  <span class="keyword">private</span> JmsTemplate jmsQueueTemplate;</span><br><span class="line">  <span class="comment">//发布订阅模式</span></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="meta">@Qualifier(&quot;jmsTopicTemplate&quot;)</span></span><br><span class="line">  <span class="keyword">private</span> JmsTemplate jmsTopicTemplate;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 点对点发送</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ptpSender</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 参数一：指定队列的名称</span></span><br><span class="line"><span class="comment">    * 参数二：MessageCreator接口，我们需要提供该接口的匿名内部实现</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    jmsQueueTemplate.send(<span class="string">&quot;spring_queue&quot;</span>, <span class="keyword">new</span> MessageCreator() &#123;</span><br><span class="line">      <span class="comment">//我们只需要返回发送的消息内容即可</span></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Message <span class="title">createMessage</span><span class="params">(Session session)</span> <span class="keyword">throws</span> JMSException </span>&#123;</span><br><span class="line">        <span class="comment">//创建文本消息</span></span><br><span class="line">        TextMessage textMessage = session.createTextMessage(<span class="string">&quot;spring testmessage&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> textMessage;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;);</span><br><span class="line">    System.out.println(<span class="string">&quot;消息发送已完成&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 发布订阅发送</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">psSender</span><span class="params">()</span></span>&#123;</span><br><span class="line">    jmsTopicTemplate.send(<span class="string">&quot;spring_topic&quot;</span>, <span class="keyword">new</span> MessageCreator() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Message <span class="title">createMessage</span><span class="params">(Session session)</span> <span class="keyword">throws</span> JMSException </span>&#123;</span><br><span class="line">        <span class="comment">//创建文本消息</span></span><br><span class="line">        TextMessage textMessage = session.createTextMessage(<span class="string">&quot;spring testmessage--topic&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> textMessage;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;);</span><br><span class="line">    System.out.println(<span class="string">&quot;消息发送已完成&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="消息消费者"><a href="#消息消费者" class="headerlink" title="消息消费者"></a>消息消费者</h3><p><strong>1. 编写监听器：监听主题消息、队列消息</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmailMessageListener</span> <span class="keyword">implements</span> <span class="title">MessageListener</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">     MapMessage mapMessage = (MapMessage) message;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">       String email = mapMessage.getString(<span class="string">&quot;email&quot;</span>);</span><br><span class="line">       System.out.println(<span class="string">&quot;消费消息：&quot;</span> + email);</span><br><span class="line">     &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">       e.printStackTrace();</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><strong>2. 编写Spring整合ActiveMQ配置：applicationContext-consumer.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">xmlns:aop</span>=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">xmlns:tx</span>=<span class="string">&quot;http://www.springframework.org/schema/tx&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">xmlns:amq</span>=<span class="string">&quot;http://activemq.apache.org/schema/core&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">xmlns:jms</span>=<span class="string">&quot;http://www.springframework.org/schema/jms&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="tag"><span class="string">   http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">   http://www.springframework.org/schema/aop</span></span></span><br><span class="line"><span class="tag"><span class="string">http://www.springframework.org/schema/aop/spring-aop.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">   http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">   http://www.springframework.org/schema/tx</span></span></span><br><span class="line"><span class="tag"><span class="string">http://www.springframework.org/schema/tx/spring-tx.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">   http://www.springframework.org/schema/jms</span></span></span><br><span class="line"><span class="tag"><span class="string">    http://www.springframework.org/schema/jms/spring-jms.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">   http://activemq.apache.org/schema/core</span></span></span><br><span class="line"><span class="tag"><span class="string">    http://activemq.apache.org/schema/core/activemq-core.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 1. 创建ActiveMQ连接工厂 --&gt;</span></span><br><span class="line">  &lt;amq:connectionFactory</span><br><span class="line">      id=&quot;amqConnectionFactory&quot;</span><br><span class="line">      userName=&quot;admin&quot; password=&quot;admin&quot;</span><br><span class="line">      brokerURL=&quot;tcp://linuxip:61616&quot;/&gt;</span><br><span class="line">  <span class="comment">&lt;!-- 2. 创建缓存工厂 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;cachingConnectionFactory&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jms.connection.CachingConnectionFactory&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 注入 连接工厂--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;targetConnectionFactory&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;amqConnectionFactory&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- session缓存数目 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sessionCacheSize&quot;</span> <span class="attr">value</span>=<span class="string">&quot;5&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--开启注解扫描--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;cn.itcast.spring_activemq_consumer&quot;</span>/&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    配置消息监听器类，监听队列或主题消息模型中的消息。从而实现消费消息。</span></span><br><span class="line"><span class="comment">    jms:listener-container</span></span><br><span class="line"><span class="comment">      destination-type 监听的JMS消息类型（queue、topic）</span></span><br><span class="line"><span class="comment">      connection-factory Spring的缓存连接工厂</span></span><br><span class="line"><span class="comment">    jms:listener</span></span><br><span class="line"><span class="comment">      destination 对应MQ中队列名称或主题名称</span></span><br><span class="line"><span class="comment">      ref     消息监听器类（实现MessageListener接口）</span></span><br><span class="line"><span class="comment">  --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 3.1 监听指定名称(email)的队列中的消息--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jms:listener-container</span> <span class="attr">destination-type</span>=<span class="string">&quot;queue&quot;</span> <span class="attr">connection-factory</span>=<span class="string">&quot;cachingConnectionFactory&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jms:listener</span> <span class="attr">destination</span>=<span class="string">&quot;email&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;emailMessageListener&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">jms:listener-container</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 3.2 监听指定名称(email)的主题中的消息 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jms:listener-container</span> <span class="attr">destination-type</span>=<span class="string">&quot;topic&quot;</span> <span class="attr">connection-factory</span>=<span class="string">&quot;cachingConnectionFactory&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jms:listener</span> <span class="attr">destination</span>=<span class="string">&quot;sms&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;smsMessageListener&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">jms:listener-container</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>3.编写测试类，发送消息</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Spring整合ActiveMQ消费消息</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    ApplicationContext ac = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;applicationContext-activemq-consumer.xml&quot;</span>);</span><br><span class="line">    System.in.read(</span><br><span class="line">	 &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-SpringBoot与ActiveMQ整合"><a href="#5-SpringBoot与ActiveMQ整合" class="headerlink" title="5.SpringBoot与ActiveMQ整合"></a>5.SpringBoot与ActiveMQ整合</h2><h3 id="消息生产者-1"><a href="#消息生产者-1" class="headerlink" title="消息生产者"></a>消息生产者</h3><p><strong>1.导入所需要的jar包</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.targer</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.targer</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-activemq<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>2.编写applicationContex-Producter.yml配置文件</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">port:</span> <span class="number">9001</span> <span class="comment">#端口</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">application:</span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">activemq-producer</span> <span class="comment"># 服务名称</span></span><br><span class="line"><span class="comment"># springboot与activemq整合配置</span></span><br><span class="line"><span class="attr">activemq:</span></span><br><span class="line"> <span class="attr">broker-url:</span> <span class="string">tcp://linuxip:61616</span> <span class="comment"># 连接地址</span></span><br><span class="line"> <span class="attr">user:</span> <span class="string">admin</span> <span class="comment"># activemq用户名</span></span><br><span class="line"> <span class="attr">password:</span> <span class="string">admin</span>  <span class="comment"># activemq密码</span></span><br><span class="line"><span class="comment"># 指定发送模式 （点对点 false ， 发布订阅 true）</span></span><br><span class="line"><span class="attr">jms:</span></span><br><span class="line"> <span class="attr">pub-sub-domain:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p><strong>3.编写启动类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerApplication</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    SpringApplication.run(ProducerApplication.class,args);</span><br><span class="line">	 &#125;</span><br><span class="line">&#125;	</span><br></pre></td></tr></table></figure>

<p><strong>4.编写生产者</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 演示SpringBoot与ActiveMQ整合- 消息生产者</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest(classes = ProducerApplication.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBootProducer</span> </span>&#123;</span><br><span class="line">  <span class="comment">//JmsMessagingTemplate: 用于工具类发送消息</span></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> JmsMessagingTemplate jmsMessagingTemplate;</span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ptpSender</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 参数一：队列的名称或主题名称</span></span><br><span class="line"><span class="comment">    * 参数二：消息内容</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    jmsMessagingTemplate.convertAndSend(<span class="string">&quot;springboot_queue&quot;</span>,<span class="string">&quot;spring bootmessage&quot;</span>);</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>5.启动测试！</strong></p>
<h3 id="消息消费者-1"><a href="#消息消费者-1" class="headerlink" title="消息消费者"></a>消息消费者</h3><p><strong>1.导入所需要jar包</strong></p>
<p><strong>2.编写applicationContext-Consumer.yml配置文件</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">port:</span> <span class="number">9002</span> <span class="comment">#端口</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">application:</span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">activemq-consumer</span> <span class="comment"># 服务名称</span></span><br><span class="line"><span class="comment"># springboot与activemq整合配置</span></span><br><span class="line"><span class="attr">activemq:</span></span><br><span class="line"> <span class="attr">broker-url:</span> <span class="string">tcp://linuxip:61616</span> <span class="comment"># 连接地址</span></span><br><span class="line"> <span class="attr">user:</span> <span class="string">admin</span> <span class="comment"># activemq用户名</span></span><br><span class="line"> <span class="attr">password:</span> <span class="string">admin</span>  <span class="comment"># activemq密码</span></span><br><span class="line"><span class="comment"># 指定发送模式 （点对点 false ， 发布订阅 true）</span></span><br><span class="line"><span class="attr">jms:</span></span><br><span class="line"> <span class="attr">pub-sub-domain:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">activemq:</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">springboot_queue</span></span><br></pre></td></tr></table></figure>

<p><strong>3.编写启动类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerApplication</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    SpringApplication.run(ConsumerApplication.class,args);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>4.编写监听器类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 用于监听消息类（既可以用于队列的监听，也可以用于主题监听）</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Component</span> <span class="comment">// 放入IOC容器</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MsgListener</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 用于接收消息的方法</span></span><br><span class="line"><span class="comment">  * destination: 队列的名称或主题的名称</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="meta">@JmsListener(destination = &quot;$&#123;activemq.name&#125;&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveMessage</span><span class="params">(Message message)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(message <span class="keyword">instanceof</span> TextMessage)&#123;</span><br><span class="line">      TextMessage textMessage = (TextMessage)message;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;接收消息：&quot;</span>+textMessage.getText());</span><br><span class="line">     &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="6-ActiveMQ消息组成与高级特性"><a href="#6-ActiveMQ消息组成与高级特性" class="headerlink" title="6.ActiveMQ消息组成与高级特性"></a>6.ActiveMQ消息组成与高级特性</h2><h3 id="JMS消息组成详解"><a href="#JMS消息组成详解" class="headerlink" title="JMS消息组成详解"></a>JMS消息组成详解</h3><p><strong>JMS消息组成格式</strong></p>
<table>
<thead>
<tr>
<th>结构</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>JMS Provider</td>
<td>消息中间件/消息服务器</td>
</tr>
<tr>
<td>JMS Producer</td>
<td>消息生产者</td>
</tr>
<tr>
<td>JMS Consumer</td>
<td>消息消费者</td>
</tr>
<tr>
<td>JMS Message</td>
<td>消息</td>
</tr>
</tbody></table>
<p><strong>JMS Message消息由三部分组成：</strong></p>
<ul>
<li>(1）消息头</li>
<li>(2）消息体</li>
<li>(3）消息属性</li>
</ul>
<h4 id="JMS消息头"><a href="#JMS消息头" class="headerlink" title="JMS消息头"></a><strong>JMS消息头</strong></h4><p>JMS消息头预定义了若干字段用于客户端与JMS提供者之间识别和发送消息，预编译头如下：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><font color="red">JMSDestination</font></td>
<td>消息发送的 Destination，在发送过程中由提供者设置</td>
</tr>
<tr>
<td><font color="red">JMSMessageID</font></td>
<td>唯一标识提供者发送的每一条消息。这个字段是在发送过程中由提供者设<br/>置的，客户机只能在消息发送后才能确定消息的 JMSMessageID</td>
</tr>
<tr>
<td><font color="red">JMSDeliveryMode</font></td>
<td>消息持久化。包含值 DeliveryMode.PERSISTENT 或者<br/>DeliveryMode.NON_PERSISTENT。</td>
</tr>
<tr>
<td>JMSTimestamp</td>
<td>提供者发送消息的时间，由提供者在发送过程中设置</td>
</tr>
<tr>
<td><font color="red">JMSExpiration</font></td>
<td>消息失效的时间，毫秒，值 0 表明消息不会过期，默认值为0</td>
</tr>
<tr>
<td><font color="red">JMSPriority</font></td>
<td>消息的优先级，由提供者在发送过程中设置。优先级 0 的优先级最低，优<br/>先级 9 的优先级最高。0-4为普通消息，5-9为加急消息</td>
</tr>
<tr>
<td><font color="red">JMSCorrelationID</font></td>
<td>通常用来链接响应消息与请求消息，由发送消息的 JMS 程序设置</td>
</tr>
<tr>
<td>JMSReplyTo</td>
<td>请求程序用它来指出回复消息应发送的地方，由发送消息的 JMS 程序设置</td>
</tr>
<tr>
<td>JMSType</td>
<td>JMS 程序用它来指出消息的类型</td>
</tr>
<tr>
<td>JMSRedelivered</td>
<td>消息的重发标志，false，代表该消息是第一次发生，true，代表该消息为<br/>重发消息</td>
</tr>
</tbody></table>
<p>不过需要注意的是，在传送消息时，消息头的值由JMS提供者来设置，因此<strong>开发者使用以上****setJMSXXX()方法分配的值就被忽略了</strong>，只有以下几个值是可以由开发者设置的：**</p>
<p><strong>JMSCorrelationID，JMSReplyTo，JMSType</strong></p>
<h4 id="JMS消息体"><a href="#JMS消息体" class="headerlink" title="JMS消息体"></a>JMS消息体</h4><p>在消息体中，JMS API定义了五种类型的消息格式，让我们可以以不同的形式发送和接受消息，并提供对已有消息格式的兼容。不同的消息类型如下：<br><strong>JMS 定义了五种不同的消息正文格式，以及调用的消息类型，允许你发送并接收一些不同形式的数据，</strong><br><strong>提供现有消息格式的一些级别的兼容性。</strong></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">· TextMessage--一个字符串对象  </span><br><span class="line">· MapMessage--一套名称-值对</span><br><span class="line">· ObjectMessage--一个序列化的 Java 对象  </span><br><span class="line">· BytesMessage--一个字节的数据流    </span><br><span class="line">· StreamMessage -- Java原始值的数据流</span><br></pre></td></tr></table></figure>

<p><strong>分别编写发送和接受测试类！</strong></p>
<p><strong>TextMessage:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 发送TextMessage消息</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMessage</span><span class="params">()</span></span>&#123;</span><br><span class="line">    jmsTemplate.send(name, <span class="keyword">new</span> MessageCreator() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Message <span class="title">createMessage</span><span class="params">(Session session)</span> <span class="keyword">throws</span> JMSException </span>&#123;</span><br><span class="line">        TextMessage textMessage = session.createTextMessage(<span class="string">&quot;文本消息&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> textMessage;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 接收TextMessage的方法</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="meta">@JmsListener(destination = &quot;$&#123;activemq.name&#125;&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveMessage</span><span class="params">(Message message)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(message <span class="keyword">instanceof</span> TextMessage)&#123;</span><br><span class="line">      TextMessage textMessage = (TextMessage)message;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;接收消息：&quot;</span>+textMessage.getText());</span><br><span class="line">     &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><strong>MapMessage:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mapMessage</span><span class="params">()</span></span>&#123;</span><br><span class="line">    jmsTemplate.send(name, <span class="keyword">new</span> MessageCreator() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Message <span class="title">createMessage</span><span class="params">(Session session)</span> <span class="keyword">throws</span> JMSException </span>&#123;</span><br><span class="line">        MapMessage mapMessage = session.createMapMessage();</span><br><span class="line">        mapMessage.setString(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;张三&quot;</span>);</span><br><span class="line">        mapMessage.setInt(<span class="string">&quot;age&quot;</span>,<span class="number">20</span>);</span><br><span class="line">        <span class="keyword">return</span> mapMessage;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JmsListener(destination = &quot;$&#123;activemq.name&#125;&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveMessage</span><span class="params">(Message message)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(message <span class="keyword">instanceof</span> MapMessage)&#123;</span><br><span class="line">      MapMessage mapMessage = (MapMessage)message;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;名称：&quot;</span>+mapMessage.getString(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;年龄：&quot;</span>+mapMessage.getString(<span class="string">&quot;age&quot;</span>));</span><br><span class="line">     &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><strong>ObjectMessage:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//发送ObjectMessage消息</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span></span>&#123;</span><br><span class="line">    jmsTemplate.send(name, <span class="keyword">new</span> MessageCreator() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Message <span class="title">createMessage</span><span class="params">(Session session)</span> <span class="keyword">throws</span> JMSException </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();<span class="comment">//编写一个User类。。。</span></span><br><span class="line">        user.setName(<span class="string">&quot;小苍&quot;</span>);</span><br><span class="line">        user.setAge(<span class="number">18</span>);</span><br><span class="line">        ObjectMessage objectMessage = session.createObjectMessage(user);</span><br><span class="line">        <span class="keyword">return</span> objectMessage;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JmsListener(destination = &quot;$&#123;activemq.name&#125;&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveMessage</span><span class="params">(Message message)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(message <span class="keyword">instanceof</span> ObjectMessage)&#123;</span><br><span class="line">      ObjectMessage objectMessage = (ObjectMessage)message;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        User user = (User)objectMessage.getObject();</span><br><span class="line">        System.out.println(user.getUsername());</span><br><span class="line">        System.out.println(user.getPassword());</span><br><span class="line">     &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><strong><font color="green">注意： ActiveMQ5.12后 ，为了安全考虑，ActiveMQ默认不接受自定义的序列化对象，需要将自定义的<br>加入到受信任的列表。</font></strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">activemq:</span></span><br><span class="line"> <span class="attr">broker-url:</span> <span class="string">tcp://linuxip:61616</span></span><br><span class="line"> <span class="attr">user:</span> <span class="string">admin</span></span><br><span class="line"> <span class="attr">password:</span> <span class="string">admin</span></span><br><span class="line"> <span class="attr">packages:</span></span><br><span class="line">  <span class="attr">trust-all:</span> <span class="literal">true</span> <span class="comment"># 添加所有包到信任列表</span></span><br></pre></td></tr></table></figure>

<p><strong>BytesMessage：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//发送BytesMessage消息</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span></span>&#123;</span><br><span class="line">    jmsTemplate.send(name, <span class="keyword">new</span> MessageCreator() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Message <span class="title">createMessage</span><span class="params">(Session session)</span> <span class="keyword">throws</span> JMSException </span>&#123;</span><br><span class="line">        BytesMessage bytesMessage = session.createBytesMessage();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          File file = <span class="keyword">new</span> File(<span class="string">&quot;d:/spring.jpg&quot;</span>);</span><br><span class="line">          FileInputStream in = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">          <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[(<span class="keyword">int</span>)file.length()];</span><br><span class="line">          in.read(bytes);</span><br><span class="line">          bytesMessage.writeBytes(bytes);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line">        <span class="keyword">return</span> bytesMessage;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JmsListener(destination=&quot;$&#123;activemq.name&#125;&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveMessage</span><span class="params">(Message message)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    BytesMessage bytesMessage = (BytesMessage)message;</span><br><span class="line">    FileOutputStream out = <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;d:/abc.jpg&quot;</span>);</span><br><span class="line">    <span class="keyword">byte</span>[] buf = <span class="keyword">new</span> <span class="keyword">byte</span>[(<span class="keyword">int</span>)bytesMessage.getBodyLength()];</span><br><span class="line">    bytesMessage.readBytes(buf);</span><br><span class="line">    out.write(buf);</span><br><span class="line">    out.close();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><strong>StreamMessage:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//发送StreamMessage消息</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span></span>&#123;</span><br><span class="line">    jmsTemplate.send(name, <span class="keyword">new</span> MessageCreator() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Message <span class="title">createMessage</span><span class="params">(Session session)</span> <span class="keyword">throws</span> JMSException </span>&#123;</span><br><span class="line">        StreamMessage streamMessage = session.createStreamMessage();</span><br><span class="line">        streamMessage.writeString(<span class="string">&quot;你好，ActiveMQ&quot;</span>);</span><br><span class="line">        streamMessage.writeInt(<span class="number">20</span>);</span><br><span class="line">        <span class="keyword">return</span> streamMessage;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JmsListener(destination=&quot;$&#123;activemq.name&#125;&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveMessage</span><span class="params">(Message message)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    StreamMessage streamMessage = (StreamMessage)message;</span><br><span class="line">    String str = streamMessage.readString();</span><br><span class="line">    <span class="keyword">int</span> i = streamMessage.readInt();</span><br><span class="line">    System.out.println(str);</span><br><span class="line">    System.out.println(i);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h4 id="JMS消息属性"><a href="#JMS消息属性" class="headerlink" title="JMS消息属性"></a>JMS消息属性</h4><p>我们可以给消息设置自定义属性，这些属性主要是提供给应用程序的。对于实现消息过滤功能，消息属性非常有用，JMS API定义了一些标准属性，<strong>JMS服务提供者可以选择性的提供部分标准属性</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">message.setStringProperty(<span class="string">&quot;Property&quot;</span>,Property);   <span class="comment">//自定义属性</span></span><br></pre></td></tr></table></figure>



<h3 id="消息持久化"><a href="#消息持久化" class="headerlink" title="消息持久化"></a>消息持久化</h3><p><strong>三种消息存储方式：</strong></p>
<ul>
<li> Memory 消息存储-基于内存的消息存储</li>
<li>基于日志消息存储方式，KahaDB是ActiveMQ的默认日志存储方式，它提供了容量的提升和恢复能力</li>
<li>基于JDBC的消息存储方式-数据存储于数据库（例如：MySQL）中</li>
</ul>
<p><img src="https://gitee.com/zhuang-kang/note-picture/raw/master/ActiveMQ%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/image-20210313173824532.png" alt="image-20210313173824532"></p>
<p><img src="https://gitee.com/zhuang-kang/note-picture/raw/master/ActiveMQ%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/image-20210313173843750.png" alt="image-20210313173843750"></p>
<p><strong>JDBC消息存储</strong></p>
<p><strong>(1)修改yml配置文件</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">activemq:</span></span><br><span class="line"> <span class="attr">broker-url:</span> <span class="string">tcp://192.168.66.133:61616</span></span><br><span class="line"> <span class="attr">user:</span> <span class="string">admin</span></span><br><span class="line"> <span class="attr">password:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">jms:</span></span><br><span class="line"> <span class="attr">pub-sub-domain:</span> <span class="literal">false</span> <span class="comment"># false：点对点队列模式， true：发布/订阅模式</span></span><br><span class="line"> <span class="attr">template:</span></span><br><span class="line">  <span class="attr">delivery-mode:</span> <span class="string">persistent</span> <span class="comment"># 持久化</span></span><br><span class="line"><span class="attr">activemq:</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">springboot-queue01</span></span><br></pre></td></tr></table></figure>

<p><strong>(2)进入配置文件中修改activemq.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--配置数据库连接池--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">&quot;mysql-ds&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://linuxip:3306/db_activemq&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;*****&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--JDBC Jdbc用于master/slave模式的数据库分享 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jdbcPersistenceAdapter</span> <span class="attr">dataSource</span>=<span class="string">&quot;#mysql-ds&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">persistenceAdapter</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>(3）拷贝mysql及durid数据源的jar包到activemq的lib目录下</strong><br>(<strong>4）重启activemq</strong></p>
<p><strong>消息事务</strong></p>
<p>消息事务，是保证消息传递原子性的一个重要特征，和JDBC的事务特征类似。<br>一个事务性发送，其中一组消息要么能够全部保证到达服务器，要么都不到达服务器。<br>生产者、消费者与消息服务器直接都支持事务性；<br>ActionMQ的事务主要偏向在生产者的应用。</p>
<p><img src="https://gitee.com/zhuang-kang/note-picture/raw/master/ActiveMQ%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/image-20210313174254444.png" alt="image-20210313174254444"></p>
<p><strong>生产者事务</strong></p>
<p>方式一</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 事务性发送--方案一</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessageTx</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//获取连接工厂</span></span><br><span class="line">    ConnectionFactory connectionFactory =jmsMessagingTemplate.getConnectionFactory();</span><br><span class="line">    Session session = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//创建连接</span></span><br><span class="line">      Connection connection = connectionFactory.createConnection();</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * 参数一：是否开启消息事务</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      session = connection.createSession(<span class="keyword">true</span>, Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">      <span class="comment">//创建生产者</span></span><br><span class="line">      MessageProducer producer =session.createProducer(session.createQueue(name));</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=<span class="number">10</span>;i++)&#123;</span><br><span class="line">        <span class="comment">//模拟异常</span></span><br><span class="line">        <span class="keyword">if</span>(i==<span class="number">4</span>)&#123;</span><br><span class="line">          <span class="keyword">int</span> a = <span class="number">10</span>/<span class="number">0</span>;</span><br><span class="line">       &#125;</span><br><span class="line">        TextMessage textMessage = session.createTextMessage(<span class="string">&quot;消息--&quot;</span> +i);</span><br><span class="line">        producer.send(textMessage);</span><br><span class="line">     &#125;</span><br><span class="line">      <span class="comment">//注意：一旦开启事务发送，那么就必须使用commit方法进行事务提交，否则消息无法到达MQ服务器</span></span><br><span class="line">      session.commit();</span><br><span class="line">   &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">      <span class="comment">//消息事务回滚</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        session.rollback();</span><br><span class="line">     &#125; <span class="keyword">catch</span> (JMSException e1) &#123;</span><br><span class="line">        e1.printStackTrace();</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>方式二</p>
<p><strong>配置类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActiveMqConfig</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">transactionManager</span><span class="params">(ConnectionFactory</span></span></span><br><span class="line"><span class="function"><span class="params">connectionFactory)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> JmsTransactionManager(connectionFactory);</span><br><span class="line">	 &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>生产者业务类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 消息发送的业务类</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageService</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> JmsMessagingTemplate jmsMessagingTemplate;</span><br><span class="line">  <span class="meta">@Value(&quot;$&#123;activemq.name&#125;&quot;)</span></span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  <span class="meta">@Transactional</span> <span class="comment">// 对消息发送加入事务管理（同时也对JDBC数据库的事务生效）</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=<span class="number">10</span>;i++) &#123;</span><br><span class="line">      <span class="comment">//模拟异常</span></span><br><span class="line">      <span class="keyword">if</span>(i==<span class="number">4</span>)&#123;</span><br><span class="line">        <span class="keyword">int</span> a = <span class="number">10</span>/<span class="number">0</span>;</span><br><span class="line">     &#125;</span><br><span class="line">      jmsMessagingTemplate.convertAndSend(name, <span class="string">&quot;消息---&quot;</span>+i);</span><br><span class="line"> 		  &#125;</span><br><span class="line">	 &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试类方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> MessageService messageService;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 事务性发送--方案二： Spring的JmsTransactionManager功能</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessageTx2</span><span class="params">()</span></span>&#123;</span><br><span class="line">    messageService.sendMessage();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<p><strong>消费者事务:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 消息消费者</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 接收消息的方法</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="meta">@JmsListener(destination=&quot;$&#123;activemq.name&#125;&quot;,containerFactory =</span></span><br><span class="line"><span class="meta">&quot;jmsQueryListenerFactory&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveMessage</span><span class="params">(TextMessage textMessage,Session session)</span> <span class="keyword">throws</span></span></span><br><span class="line"><span class="function">JMSException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;消息内容：&quot;</span> + textMessage.getText() + <span class="string">&quot;,是否重发：&quot;</span></span><br><span class="line">+ textMessage.getJMSRedelivered());</span><br><span class="line">      <span class="keyword">int</span> i = <span class="number">100</span>/<span class="number">0</span>; <span class="comment">//模拟异常</span></span><br><span class="line">     </span><br><span class="line">      session.commit();<span class="comment">//提交事务</span></span><br><span class="line">   &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        session.rollback();<span class="comment">//回滚事务</span></span><br><span class="line">     &#125; <span class="keyword">catch</span> (JMSException e1) &#123;</span><br><span class="line">     &#125;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line"> 		  &#125;</span><br><span class="line">	 &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="消息确认机制"><a href="#消息确认机制" class="headerlink" title="消息确认机制"></a>消息确认机制</h4><p>JMS消息只有在被确认之后，才认为已经被成功地消费了。消息的成功消费通常包含三个阶段：<strong>客户接</strong><br><strong>收消息、客户处理消息和消息被确认</strong>。在事务性会话中，当一个事务被提交的时候，确认自动发生。在<br>非事务性会话中，消息何时被确认取决于创建会话时的应答模式（acknowledgement mode）。该参<br>数有以下三个可选值：</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>Session.AUTO_ACKNOWLEDGE</td>
<td>当客户成功的从receive方法返回的时候，或者从MessageListener.onMessage方法成功返回的时候，会话自动确认客户收到的消息</td>
</tr>
<tr>
<td>Session.CLIENT_ACKNOWLEDGE</td>
<td>客户通过消息的acknowledge方法确认消息。需要注意的是，在这种模式中，确认是在会话层上进行：确认一个被消费的消息将自动确认所有已被会话消费的消息。例如，如果一个消息消费者消费了10个消息，然后确认第5个消息，那么所有10个消息都被确认</td>
</tr>
<tr>
<td>Session.DUPS_ACKNOWLEDGE</td>
<td>该选择只是会话迟钝确认消息的提交。如果JMS provider失败，那么可能会导致一些重复的消息。如果是重复的消息，那么JMS provider必须把消息头的JMSRedelivered字段设置为true</td>
</tr>
</tbody></table>
<p><strong>注意：消息确认机制与事务机制是冲突的，只能选其中一种。所以演示消息确认前，先关闭事务。</strong></p>
<p><img src="https://gitee.com/zhuang-kang/note-picture/raw/master/ActiveMQ%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/image-20210313195231306.png" alt="image-20210313195231306"></p>
<p><strong>(1）auto_acknowledge 自动确认</strong></p>
<p>编写配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActiveMqConfig</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Bean(name=&quot;jmsQueryListenerFactory&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> DefaultJmsListenerContainerFactory <span class="title">jmsListenerContainerFactory</span><span class="params">(ConnectionFactory connectionFactory)</span></span>&#123;</span><br><span class="line">    DefaultJmsListenerContainerFactory factory=<span class="keyword">new</span> DefaultJmsListenerContainerFactory();</span><br><span class="line">    factory.setConnectionFactory(connectionFactory);</span><br><span class="line">    factory.setSessionTransacted(<span class="keyword">false</span>); <span class="comment">// 不开启事务操作</span></span><br><span class="line">    factory.setSessionAcknowledgeMode(<span class="number">1</span>); <span class="comment">//自动确认</span></span><br><span class="line">    <span class="keyword">return</span> factory;</span><br><span class="line">	 &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>消费者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 消息消费者</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 接收消息的方法</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="meta">@JmsListener(destination=&quot;$&#123;activemq.name&#125;&quot;,containerFactory =</span></span><br><span class="line"><span class="meta">&quot;jmsQueryListenerFactory&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveMessage</span><span class="params">(TextMessage textMessage)</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;消息内容：&quot;</span> + textMessage.getText() + <span class="string">&quot;,是否重发：&quot;</span></span><br><span class="line">+ textMessage.getJMSRedelivered());</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">   &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>如果消费方接收消息失败， JMS服务器会重发消息，默认重发6次。</strong></p>
<p><strong>(2）dups_ok_acknowledge</strong><br>类似于 auto_acknowledge 确认机制，为自动批量确认而生，而且具有“延迟”确认的特点，ActiveMQ<br>会根据内部算法，在收到一定数量的消息自动进行确认。 在此模式下，可能会出现重复消息，如果消费<br>方不允许重复消费，不建议使用！</p>
<p><strong>(3）client_acknowledge 手动确认</strong></p>
<p>编写配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActiveMqConfig</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Bean(name=&quot;jmsQueryListenerFactory&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> DefaultJmsListenerContainerFactory <span class="title">jmsListenerContainerFactory</span><span class="params">(ConnectionFactory connectionFactory)</span></span>&#123;</span><br><span class="line">    DefaultJmsListenerContainerFactory factory=<span class="keyword">new</span> DefaultJmsListenerContainerFactory();</span><br><span class="line">    factory.setConnectionFactory(connectionFactory);</span><br><span class="line">    factory.setSessionTransacted(<span class="keyword">false</span>); <span class="comment">// 不开启事务操作</span></span><br><span class="line">    factory.setSessionAcknowledgeMode(<span class="number">4</span>); <span class="comment">//手动确认</span></span><br><span class="line">    <span class="keyword">return</span> factory;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>消费者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 消息消费者</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 接收消息的方法</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="meta">@JmsListener(destination=&quot;$&#123;activemq.name&#125;&quot;,containerFactory =&quot;jmsQueryListenerFactory&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveMessage</span><span class="params">(TextMessage textMessage)</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;消息内容：&quot;</span> + textMessage.getText() + <span class="string">&quot;,是否重发：&quot;</span>+textMessage.getJMSRedelivered());</span><br><span class="line">      textMessage.acknowledge(); <span class="comment">// 确认收到消息，一旦消息确认，消息不会重新发送</span></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">   &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="消息投递方式"><a href="#消息投递方式" class="headerlink" title="消息投递方式"></a>消息投递方式</h3><p><strong>1、异步投递 vs 同步投递</strong><br><strong>同步发送：</strong><br>消息生产者使用持久（Persistent）传递模式发送消息的时候，Producer.send() 方法会被阻塞，直到broker 发送一个确认消息给生产者(ProducerAck)，这个确认消息暗示broker已经成功接收到消息并把消息保存到二级存储中。<br><strong>异步发送:</strong><br>如果应用程序能够容忍一些消息的丢失，那么可以使用异步发送。异步发送不会在受到broker的确认之前一直阻塞 Producer.send方法。</p>
<p>想要使用异步，在brokerURL中增加 jms.alwaysSyncSend=false&amp;jms.useAsyncSend=true属性(1）如果设置了alwaysSyncSend=true系统将会忽略useAsyncSend设置的值都采用同步 2）当alwaysSyncSend=false时，“NON_PERSISTENT”(非持久化)、事务中的消息将使用“异步发送” 3）当alwaysSyncSend=false时，如果指定了useAsyncSend=true，“PERSISTENT”类型的消息使用异步发送。如果useAsyncSend=false，“PERSISTENT”类型的消息使用同步发送。</p>
<p><strong>总结： 默认情况(alwaysSyncSend=false,useAsyncSend=false)，非持久化消息、事务内的消息均采用</strong><br><strong>异步发送；对于持久化消息采用同步发送！！！</strong></p>
<p><strong>2、配置异步投递的方式</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>在连接上配置</span><br><span class="line"><span class="keyword">new</span> ActiveMQConnectionFactory(<span class="string">&quot;tcp://locahost:61616?jms.useAsyncSend=true&quot;</span>);</span><br><span class="line"><span class="number">2.</span>通过ConnectionFactory</span><br><span class="line">((ActiveMQConnectionFactory)connectionFactory).setUseAsyncSend(<span class="keyword">true</span>);</span><br><span class="line"><span class="number">3.</span>通过connection</span><br><span class="line">((ActiveMQConnection)connection).setUseAsyncSend(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>



<p><strong>注意：如果是Spring或SpringBoot项目，通过修改JmsTemplate的默认参数实现异步或同步投递</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActiveConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 配置用于异步发送的非持久化JmsTemplate</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> JmsTemplate <span class="title">asynJmsTemplate</span><span class="params">(PooledConnectionFactory</span></span></span><br><span class="line"><span class="function"><span class="params">pooledConnectionFactory)</span> </span>&#123;</span><br><span class="line">    JmsTemplate template = <span class="keyword">new</span> JmsTemplate(pooledConnectionFactory);</span><br><span class="line">    template.setExplicitQosEnabled(<span class="keyword">true</span>);</span><br><span class="line">    template.setDeliveryMode(DeliveryMode.NON_PERSISTENT);</span><br><span class="line">    <span class="keyword">return</span> template;</span><br><span class="line"> &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 配置用于同步发送的持久化JmsTemplate</span></span><br><span class="line"><span class="comment">  */</span> </span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> JmsTemplate <span class="title">synJmsTemplate</span><span class="params">(PooledConnectionFactory</span></span></span><br><span class="line"><span class="function"><span class="params">pooledConnectionFactory)</span> </span>&#123;</span><br><span class="line">    JmsTemplate template = <span class="keyword">new</span> JmsTemplate(pooledConnectionFactory);</span><br><span class="line">    <span class="keyword">return</span> template;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><strong>异步投递如何确认发送成功？</strong><br>异步投递丢失消息的场景是：生产者设置 UseAsyncSend=true，使用 producer.send（msg）持续发送消息。</p>
<p>由于消息不阻塞，生产者会认为所有 send 的消息均被成功发送至 MQ。如果 MQ 突然宕机，此时生产者端内存中尚未被发送至 MQ 的消息都会丢失。这时，可以给异步投递方法接收回调，以确认消息是否发送成功！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 异步投递，回调函数</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="meta">@RequestMapping(&quot;/send&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">sendQueue</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Connection connection = <span class="keyword">null</span>;</span><br><span class="line">    Session session = <span class="keyword">null</span>;</span><br><span class="line">    ActiveMQMessageProducer producer = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 获取连接工厂</span></span><br><span class="line">    ConnectionFactory connectionFactory =jmsMessagingTemplate.getConnectionFactory();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      connection = connectionFactory.createConnection();</span><br><span class="line">      session = connection.createSession(<span class="keyword">true</span>, Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">      Queue queue = session.createQueue(name);</span><br><span class="line">      <span class="keyword">int</span> count = <span class="number">10</span>;</span><br><span class="line">      producer = session.createProducer(queue);</span><br><span class="line">      producer.setDeliveryMode(DeliveryMode.NON_PERSISTENT);</span><br><span class="line">      <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        <span class="comment">//创建需要发送的消息</span></span><br><span class="line">        TextMessage textMessage = session.createTextMessage(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">        <span class="comment">//设置消息唯一ID</span></span><br><span class="line">        String msgid = UUID.randomUUID().toString();</span><br><span class="line">        textMessage.setJMSMessageID(msgid);</span><br><span class="line">        producer.send(textMessage, <span class="keyword">new</span> AsyncCallback() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 使用msgid标识来进行消息发送成功的处理</span></span><br><span class="line">            System.out.println(msgid+<span class="string">&quot; 消息发送成功&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onException</span><span class="params">(JMSException exception)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 使用msgid表示进行消息发送失败的处理</span></span><br><span class="line">            System.out.println(msgid+<span class="string">&quot; 消息发送失败&quot;</span>);</span><br><span class="line">            exception.printStackTrace();</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">     &#125;</span><br><span class="line">      session.commit();</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<p><strong>延迟投递</strong><br>生产者提供两个发送消息的方法，一个是即时发送消息，一个是延时发送消息。<br><strong>1、修改activemq.xml</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&lt;broker</span> <span class="string">xmlns=&quot;http://activemq.apache.org/schema/core&quot;</span> <span class="string">...</span></span><br><span class="line"> <span class="string">schedulerSupport=&quot;true&quot;</span> <span class="string">&gt;</span></span><br><span class="line"> <span class="string">......</span></span><br><span class="line"><span class="string">&lt;/broker&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：添加 schedulerSupport=”true”配置</strong></p>
<p><strong>2、在代码中设置延迟时长</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 延时投递</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">sendQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Connection connection = <span class="keyword">null</span>;</span><br><span class="line">    Session session = <span class="keyword">null</span>;</span><br><span class="line">    ActiveMQMessageProducer producer = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 获取连接工厂</span></span><br><span class="line">    ConnectionFactory connectionFactory =jmsMessagingTemplate.getConnectionFactory();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      connection = connectionFactory.createConnection();</span><br><span class="line">      session = connection.createSession(<span class="keyword">true</span>, Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">      Queue queue = session.createQueue(name);</span><br><span class="line">      <span class="keyword">int</span> count = <span class="number">10</span>;</span><br><span class="line">      producer = (ActiveMQMessageProducer) session.createProducer(queue);</span><br><span class="line">      producer.setDeliveryMode(DeliveryMode.NON_PERSISTENT);</span><br><span class="line">      <span class="comment">//创建需要发送的消息</span></span><br><span class="line">      TextMessage textMessage = session.createTextMessage(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">      <span class="comment">//设置延时时长(延时10秒)</span></span><br><span class="line">      textMessage.setLongProperty(ScheduledMessage.AMQ_SCHEDULED_DELAY,<span class="number">10000</span>);</span><br><span class="line">      producer.send(textMessage);</span><br><span class="line">      session.commit();</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<p><strong>定时投递</strong></p>
<p>1、启动类添加定时注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableScheduling</span> <span class="comment">// 开启定时功能</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyActiveMQApplication</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    SpringApplication.run(MyActiveMQApplication.class,args);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、在生产者添加@Scheduled设置定时</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 消息生产者</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerController3</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Value(&quot;$&#123;activemq.name&#125;&quot;)</span></span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> JmsMessagingTemplate jmsMessagingTemplate;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 延时投递</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="comment">//每隔3秒定投</span></span><br><span class="line">  <span class="meta">@Scheduled(fixedDelay = 3000)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    jmsMessagingTemplate.convertAndSend(name, <span class="string">&quot;消息ID:&quot;</span> +UUID.randomUUID().toString().substring(<span class="number">0</span>,<span class="number">6</span>));</span><br><span class="line">    System.out.println(<span class="string">&quot;消息发送成功...&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="死信队列"><a href="#死信队列" class="headerlink" title="死信队列"></a>死信队列</h3><p><strong>DLQ-Dead Letter Queue，死信队列，用来保存处理失败或者过期的消息</strong></p>
<blockquote>
<p>出现以下情况时，消息会被重发：<br>A transacted session is used and rollback() is called.<br>A transacted session is closed before commit is called.<br>A session is using CLIENT_ACKNOWLEDGE and Session.recover() is called.<br>当一个消息被重发超过6(缺省为6次)次数时，会给broker发送一个”Poison ack”，这个消息被认为是apoison pill，这时broker会将这个消息发送到死信队列，以便后续处理。<br>注意两点：<br><strong>1）缺省持久消息过期，会被送到DLQ，非持久消息不会送到DLQ</strong><br><strong>2）缺省的死信队列是ActiveMQ.DLQ，如果没有特别指定，死信都会被发送到这个队列。</strong><br>可以通过配置文件(activemq.xml)来调整死信发送策略。</p>
</blockquote>
<p><strong>1、修改配置文件中的activemq.xml</strong></p>
<p><strong>为每个队列建立独立的死信队列</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">destinationPolicy</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">policyMap</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">policyEntries</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">queue</span>=<span class="string">&quot;&gt;&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">deadLetterStrategy</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">individualDeadLetterStrategy</span> <span class="attr">queuePrefix</span>=<span class="string">&quot;DLQ.&quot;</span></span></span><br><span class="line"><span class="tag">             <span class="attr">useQueueForQueueMessages</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">deadLetterStrategy</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">policyEntry</span>&gt;</span></span><br><span class="line">   </span><br><span class="line">         <span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">topic</span>=<span class="string">&quot;&gt;&quot;</span> &gt;</span>        </span><br><span class="line">          <span class="tag">&lt;<span class="name">pendingMessageLimitStrategy</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">constantPendingMessageLimitStrategy</span> <span class="attr">limit</span>=<span class="string">&quot;1000&quot;</span>/&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">pendingMessageLimitStrategy</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">policyEntry</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">policyEntries</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">policyMap</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">destinationPolicy</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>2、RedeliveryPolicy重发策略设置</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActiveMqConfig</span> </span>&#123;</span><br><span class="line">  <span class="comment">//RedeliveryPolicy重发策略设置</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RedeliveryPolicy <span class="title">redeliveryPolicy</span><span class="params">()</span></span>&#123;</span><br><span class="line">    RedeliveryPolicy  redeliveryPolicy=  <span class="keyword">new</span> RedeliveryPolicy();</span><br><span class="line">    <span class="comment">//是否在每次尝试重新发送失败后,增长这个等待时间</span></span><br><span class="line">    redeliveryPolicy.setUseExponentialBackOff(<span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">//重发次数,默认为6次  这里设置为10次</span></span><br><span class="line">    redeliveryPolicy.setMaximumRedeliveries(<span class="number">10</span>);</span><br><span class="line">    <span class="comment">//重发时间间隔,默认为1秒</span></span><br><span class="line">    redeliveryPolicy.setInitialRedeliveryDelay(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">//第一次失败后重新发送之前等待500毫秒,第二次失败再等待500 * 2毫秒,这里的2就是value</span></span><br><span class="line">    redeliveryPolicy.setBackOffMultiplier(<span class="number">2</span>);</span><br><span class="line">    <span class="comment">//是否避免消息碰撞</span></span><br><span class="line">    redeliveryPolicy.setUseCollisionAvoidance(<span class="keyword">false</span>);</span><br><span class="line">    <span class="comment">//设置重发最大拖延时间-1 表示没有拖延只有UseExponentialBackOff(true)为true时生</span></span><br><span class="line">效</span><br><span class="line">    redeliveryPolicy.setMaximumRedeliveryDelay(-<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> redeliveryPolicy;</span><br><span class="line"> &#125;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> ActiveMQConnectionFactory activeMQConnectionFactory</span><br><span class="line">(<span class="meta">@Value(&quot;$&#123;spring.activemq.broker-url&#125;&quot;)</span>String url,RedeliveryPolicy</span><br><span class="line">redeliveryPolicy)&#123;</span><br><span class="line">    ActiveMQConnectionFactory activeMQConnectionFactory =</span><br><span class="line">        <span class="keyword">new</span> ActiveMQConnectionFactory(</span><br><span class="line">            <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">            <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">            url);</span><br><span class="line">    activeMQConnectionFactory.setRedeliveryPolicy(redeliveryPolicy);</span><br><span class="line">    <span class="keyword">return</span> activeMQConnectionFactory;</span><br><span class="line"> &#125;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">transactionManager</span><span class="params">(ConnectionFactory</span></span></span><br><span class="line"><span class="function"><span class="params">connectionFactory)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> JmsTransactionManager(connectionFactory);</span><br><span class="line"> &#125;</span><br><span class="line">  <span class="meta">@Bean(name=&quot;jmsQueryListenerFactory&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> DefaultJmsListenerContainerFactory </span><br><span class="line">jmsListenerContainerFactory(ConnectionFactory</span><br><span class="line">connectionFactory,PlatformTransactionManager transactionManager)&#123;</span><br><span class="line">    DefaultJmsListenerContainerFactory  factory=<span class="keyword">new</span></span><br><span class="line">DefaultJmsListenerContainerFactory ();</span><br><span class="line">    factory.setTransactionManager(transactionManager);</span><br><span class="line">    factory.setConnectionFactory(connectionFactory);</span><br><span class="line">    factory.setSessionTransacted(<span class="keyword">true</span>); <span class="comment">// 开启事务</span></span><br><span class="line">    factory.setSessionAcknowledgeMode(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> factory;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="7-ActiveMQ企业面试经典问题"><a href="#7-ActiveMQ企业面试经典问题" class="headerlink" title="7.ActiveMQ企业面试经典问题"></a>7.ActiveMQ企业面试经典问题</h2><h3 id="问题：ActiveMQ宕机了怎么办？"><a href="#问题：ActiveMQ宕机了怎么办？" class="headerlink" title="问题：ActiveMQ宕机了怎么办？"></a>问题：ActiveMQ宕机了怎么办？</h3><p><strong>(1）ActiveMQ主从集群方案：Zookeeper集群+ Replicated LevelDB + ActiveMQ集群</strong></p>
<p><strong>官网<a target="_blank" rel="noopener" href="http://activemq.apache.org/replicated-leveldb-store">http://activemq.apache.org/replicated-leveldb-store</a></strong></p>
<p><img src="https://gitee.com/zhuang-kang/note-picture/raw/master/ActiveMQ%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/image-20210313200908657.png" alt="image-20210313200908657"></p>
<p><strong>(2）集群信息概览</strong></p>
<table>
<thead>
<tr>
<th>Zookeeper 端口</th>
<th>ActiveMQweb端口</th>
<th>ActiveMQ协议端口</th>
</tr>
</thead>
<tbody><tr>
<td>2181</td>
<td>8161</td>
<td>61616</td>
</tr>
<tr>
<td>2182</td>
<td>8162</td>
<td>61617</td>
</tr>
<tr>
<td>2183</td>
<td>8163</td>
<td>61618</td>
</tr>
</tbody></table>
<p><strong>(3）先搭建Zookeeper集群</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">1）上传zookeeper-3.4.6.tar.gz到linux</span><br><span class="line">2）解压：tar -xzf zookeeper-3.4.6.tar.gz</span><br><span class="line">3）创建根目录： mkdir /root/zookeeper</span><br><span class="line">4）创建节点目录及数据，日志存放目录：</span><br><span class="line">mkdir -p zookeeper/218&#123;1,2,3&#125;/&#123;data,datalogs&#125;</span><br><span class="line">3个节点的子文件夹为：2181,2182,2183</span><br><span class="line">5）复制Zookeeper到每个节点目录下</span><br><span class="line">cp -r zookeeper-3.4.6 zookeeper/2181</span><br><span class="line">cp -r zookeeper-3.4.6 zookeeper/2182</span><br><span class="line">cp -r zookeeper-3.4.6 zookeeper/2183</span><br><span class="line">6）移除原始目录</span><br><span class="line">rm -rf zookeeper-3.4.14/</span><br><span class="line">7）修改2181节点的zoo.cfg</span><br><span class="line">cd zookeeper/2181/zookeeper-3.4.6/conf/</span><br><span class="line">cp zoo_sample.cfg zoo.cfg</span><br><span class="line">vi zoo.cfg</span><br><span class="line">内容如下：</span><br><span class="line">clientPort=2181</span><br><span class="line">dataDir=/root/zookeeper/2181/data</span><br><span class="line">dataLogDir=/root/zookeeper/2181/datalogs</span><br><span class="line">server.1=192.168.66.133:2881:3881</span><br><span class="line">server.2=192.168.66.133:2882:3882</span><br><span class="line">server.3=192.168.66.133:2883:3883</span><br><span class="line">8）相同方式修改2182及2183节点的zoo.cfg</span><br><span class="line">2182配置为：</span><br><span class="line">clientPort=2182</span><br><span class="line">dataDir=/root/zookeeper/2182/data</span><br><span class="line">dataLogDir=/root/zookeeper/2182/datalogs</span><br><span class="line">server.1=192.168.66.133:2881:3881</span><br><span class="line">server.2=192.168.66.133:2882:3882</span><br><span class="line">server.3=192.168.66.133:2883:3883</span><br><span class="line">2183配置为：</span><br><span class="line">clientPort=2183</span><br><span class="line">dataDir=/root/zookeeper/2183/data</span><br><span class="line">dataLogDir=/root/zookeeper/2183/datalogs</span><br><span class="line">server.1=192.168.66.133:2881:3881</span><br><span class="line">server.2=192.168.66.133:2882:3882</span><br><span class="line">server.3=192.168.66.133:2883:3883</span><br><span class="line"></span><br><span class="line">9）每个节点必须有myid配置文件，记录节点的唯一标识，必须放在dataDir文件夹下。而且id值必须与上面</span><br><span class="line">配置的server.x中的x对应</span><br><span class="line">touch 2181/data/myid &amp;&amp; echo &quot;1&quot; &gt; 2181/data/myid</span><br><span class="line">touch 2182/data/myid &amp;&amp; echo &quot;2&quot; &gt; 2182/data/myid</span><br><span class="line">touch 2183/data/myid &amp;&amp; echo &quot;3&quot; &gt; 2183/data/myid</span><br><span class="line">查看是否创建成功：</span><br><span class="line">more 218*/data/myid</span><br><span class="line">10）分别启动三台Zookeeper</span><br><span class="line">启动：</span><br><span class="line">cd 2181/ &amp;&amp; zookeeper-3.4.6/bin/zkServer.sh start</span><br><span class="line">cd 2182/ &amp;&amp; zookeeper-3.4.6/bin/zkServer.sh start</span><br><span class="line">cd 2183/ &amp;&amp; zookeeper-3.4.6/bin/zkServer.sh start</span><br><span class="line">查看状态：</span><br><span class="line">2181/zookeeper-3.4.6/bin/zkServer.sh status</span><br><span class="line">2182/zookeeper-3.4.6/bin/zkServer.sh status</span><br><span class="line">2183/zookeeper-3.4.6/bin/zkServer.sh status</span><br><span class="line">看到Mode: leader的Zookeeper为主节点，其他为从节点。</span><br></pre></td></tr></table></figure>

<p><strong>（4）搭建ActiveMQ集群</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">1）上传apache-activemq-5.15.9-bin.tar.gz到linux</span><br><span class="line">2）解压：tar -xzf apache-activemq-5.15.9-bin.tar.gz</span><br><span class="line">3）创建三个节点目录</span><br><span class="line">    mkdir activemq</span><br><span class="line">    mkdir -p activemq/816&#123;1,2,3&#125;</span><br><span class="line">4）复制activemq到每个节点目录</span><br><span class="line">    cp -r apache-activemq-5.15.9 activemq/8161</span><br><span class="line">    cp -r apache-activemq-5.15.9 activemq/8162</span><br><span class="line">    cp -r apache-activemq-5.15.9 activemq/8163</span><br><span class="line">5）修改每个节点的activemq.xml</span><br><span class="line">    必须使用相同的集群名称</span><br><span class="line">    &lt;broker xmlns=&quot;http://activemq.apache.org/schema/core&quot; brokerName=&quot;itheima_mq&quot;</span><br><span class="line">    dataDirectory=&quot;$&#123;activemq.data&#125;&quot;&gt;</span><br><span class="line">    添加配置：</span><br><span class="line">    61616：</span><br><span class="line">    &lt;persistenceAdapter&gt;</span><br><span class="line">    &lt;replicatedLevelDB</span><br><span class="line">    directory=&quot;$&#123;activemq.data&#125;/leveldb&quot;</span><br><span class="line">    replicas=&quot;3&quot;</span><br><span class="line">    bind=&quot;tcp://0.0.0.0:61616&quot;</span><br><span class="line">    zkAddress=&quot;192.168.66.133:2181,192.168.66.133:2182,192.168.66.133:2183&quot;</span><br><span class="line">    hostname=&quot;192.168.66.133&quot;</span><br><span class="line">    zkPath=&quot;/activemq/leveldb-stores&quot; /&gt;</span><br><span class="line">    &lt;/persistenceAdapter&gt;</span><br><span class="line">    61617：</span><br><span class="line">    &lt;persistenceAdapter&gt;</span><br><span class="line">    &lt;replicatedLevelDB</span><br><span class="line">    directory=&quot;$&#123;activemq.data&#125;/leveldb&quot;</span><br><span class="line">    replicas=&quot;3&quot;</span><br><span class="line">    bind=&quot;tcp://0.0.0.0:61617&quot;</span><br><span class="line">    zkAddress=&quot;192.168.66.133:2181,192.168.66.133:2182,192.168.66.133:2183&quot;</span><br><span class="line">    hostname=&quot;192.168.66.133&quot;</span><br><span class="line">    zkPath=&quot;/activemq/leveldb-stores&quot; /&gt;</span><br><span class="line">    &lt;/persistenceAdapter&gt;</span><br><span class="line">    61618：</span><br><span class="line">    &lt;persistenceAdapter&gt;</span><br><span class="line">    &lt;replicatedLevelDB</span><br><span class="line">    directory=&quot;$&#123;activemq.data&#125;/leveldb&quot;</span><br><span class="line">    replicas=&quot;3&quot;</span><br><span class="line">    bind=&quot;tcp://0.0.0.0:61618&quot;</span><br><span class="line">    zkAddress=&quot;192.168.66.133:2181,192.168.66.133:2182,192.168.66.133:2183&quot;</span><br><span class="line">    hostname=&quot;192.168.66.133&quot;</span><br><span class="line">    zkPath=&quot;/activemq/leveldb-stores&quot; /&gt;</span><br><span class="line">    &lt;/persistenceAdapter&gt;</span><br><span class="line">6）修改jetty.xml</span><br><span class="line">    &lt;bean id=&quot;jettyPort&quot; class=&quot;org.apache.activemq.web.WebConsolePort&quot; init-</span><br><span class="line">    method=&quot;start&quot;&gt;</span><br><span class="line">          &lt;!-- the default port number for the web console --&gt;</span><br><span class="line">       &lt;property name=&quot;host&quot; value=&quot;0.0.0.0&quot;/&gt;</span><br><span class="line">       &lt;property name=&quot;port&quot; value=&quot;8161&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">    </span><br><span class="line">7）分别为8181,8182,8183分别启动每台activemq可以使用ZooInspector工具查看ActiveMQ是否注册成功</span><br></pre></td></tr></table></figure>

<p><strong>(5）生产者和消费者的broker-url需要修改</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">activemq:</span></span><br><span class="line"> <span class="attr">broker-url: failover:</span></span><br><span class="line"><span class="string">(tcp://linuxip:61616,tcp://linuxip:61617,tcp://linuxip:616168)</span></span><br><span class="line"> <span class="attr">user:</span> <span class="string">admin</span></span><br><span class="line"> <span class="attr">password:</span> <span class="string">admin</span></span><br></pre></td></tr></table></figure>

<h3 id="问题：如何防止消费方消息重复消费？"><a href="#问题：如何防止消费方消息重复消费？" class="headerlink" title="问题：如何防止消费方消息重复消费？"></a>问题：如何防止消费方消息重复消费？</h3><p><strong>解决消费方幂等性问题！</strong><br>如果因为网络延迟等原因，MQ无法及时接收到消费方的应答，导致MQ重试。在重试过程中造成重复消费的问题。<br>解决思路：</p>
<ul>
<li>如果消费方是做数据库操作，那么可以把消息的ID作为表的唯一主键，这样在重试的情<br>况下，会触发主键冲突，从而避免数据出现脏数据。</li>
<li>如果消费方不是做数据库操作，那么可以借助第三方的应用，例如Redis，来记录消费记录。每次消<br>息被消费完成时候，把当前消息的ID作为key存入redis，每次消费前，先到redis查询有没有该消息的消费记录。</li>
</ul>
<h3 id="问题：如何防止消息丢失？"><a href="#问题：如何防止消息丢失？" class="headerlink" title="问题：如何防止消息丢失？"></a>问题：如何防止消息丢失？</h3><p>以下手段可以防止消息丢失：<br>1）在消息生产者和消费者使用事务<br>2）在消费方采用手动消息确认（ACK）<br>3）消息持久化，例如JDBC或日志</p>
<p><strong>学习地址<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1vJ41177j1?p=1">https://www.bilibili.com/video/BV1vJ41177j1?p=1</a></strong></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">康小庄</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2021/03/05/ActiveMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">http://example.com/2021/03/05/ActiveMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">康小庄的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a></div><div class="post_share"><div class="social-share" data-image="https://pic.imgdb.cn/item/60cda4a1844ef46bb2083fc5.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechatpay.png" target="_blank"><img class="post-qr-code-img" src="/img/wechatpay.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.png" target="_blank"><img class="post-qr-code-img" src="/img/alipay.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/03/11/Git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><img class="prev-cover" src="https://z3.ax1x.com/2021/06/01/2Ku3dA.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Git学习笔记</div></div></a></div><div class="next-post pull-right"><a href="/2021/02/25/MyBatis%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><img class="next-cover" src="https://pic.imgdb.cn/item/60c8b921844ef46bb2200cfc.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">MyBatis学习笔记</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/11/20/SpringBoot2学习笔记/" title="SpringBoot2学习笔记"><img class="cover" src="https://pic.imgdb.cn/item/60e429695132923bf87fba9c.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-20</div><div class="title">SpringBoot2学习笔记</div></div></a></div><div><a href="/2021/04/07/SpringBoot学习笔记/" title="SpringBoot学习笔记"><img class="cover" src="https://pic.imgdb.cn/item/60e429695132923bf87fba9c.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-07</div><div class="title">SpringBoot学习笔记</div></div></a></div><div><a href="/2022/01/01/Mysql从入门到精通/" title="Mysql从入门到精通"><img class="cover" src="https://z3.ax1x.com/2021/06/01/2KQvmF.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-01</div><div class="title">Mysql从入门到精通</div></div></a></div><div><a href="/2021/11/29/Oracle学习笔记/" title="Oracle学习笔记"><img class="cover" src="https://pic.imgdb.cn/item/61a4da2d2ab3f51d91baa483.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-29</div><div class="title">Oracle学习笔记</div></div></a></div><div><a href="/2021/10/23/MybatisPlus学习笔记/" title="MyBatisPlus学习笔记"><img class="cover" src="https://baomidou.com/img/relationship-with-mybatis.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-23</div><div class="title">MyBatisPlus学习笔记</div></div></a></div><div><a href="/2021/04/29/Vue学习笔记/" title="Vue学习笔记"><img class="cover" src="https://pic.imgdb.cn/item/60cda866844ef46bb228322f.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-29</div><div class="title">Vue学习笔记</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ActiveMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0"><span class="toc-number">1.</span> <span class="toc-text">ActiveMQ学习笔记</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-ActiveMQ%E5%85%A5%E9%97%A8"><span class="toc-number">1.1.</span> <span class="toc-text">1.ActiveMQ入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.1.1.</span> <span class="toc-text">消息中间件应用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">异步处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E8%A7%A3%E8%80%A6"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">应用解耦</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E9%87%8F%E5%89%8A%E5%B3%B0"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">流量削峰</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ActiveMQ%E7%AE%80%E4%BB%8B%E5%8F%8AJMS"><span class="toc-number">1.1.2.</span> <span class="toc-text">ActiveMQ简介及JMS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JMS%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">JMS消息模型</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%82%B9%E5%AF%B9%E7%82%B9%E6%A8%A1%E5%9E%8B%E7%9A%84%E7%89%B9%E7%82%B9"><span class="toc-number">1.1.2.1.1.</span> <span class="toc-text">点对点模型的特点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%91%E5%B8%83-%E8%AE%A2%E9%98%85%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.1.2.1.2.</span> <span class="toc-text">发布&#x2F;订阅模型</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JMS%E7%BC%96%E7%A8%8BAPI"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">JMS编程API</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1%EF%BC%89ConnectionFactory"><span class="toc-number">1.1.2.2.1.</span> <span class="toc-text">(1）ConnectionFactory</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2%EF%BC%89Destination"><span class="toc-number">1.1.2.2.2.</span> <span class="toc-text">(2）Destination</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3%EF%BC%89Connection"><span class="toc-number">1.1.2.2.3.</span> <span class="toc-text">(3）Connection</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4%EF%BC%89Session"><span class="toc-number">1.1.2.2.4.</span> <span class="toc-text">(4）Session</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5%EF%BC%89Producter"><span class="toc-number">1.1.2.2.5.</span> <span class="toc-text">(5）Producter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6%EF%BC%89Consumer"><span class="toc-number">1.1.2.2.6.</span> <span class="toc-text">(6）Consumer</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7%EF%BC%89MessageListener"><span class="toc-number">1.1.2.2.7.</span> <span class="toc-text">(7）MessageListener</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-ActiveMQ%E5%AE%89%E8%A3%85"><span class="toc-number">1.2.</span> <span class="toc-text">2.ActiveMQ安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%8E%9F%E7%94%9FTMS-API%E6%93%8D%E4%BD%9CActiveMQ"><span class="toc-number">1.3.</span> <span class="toc-text">3.原生TMS API操作ActiveMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PTP-%E6%A8%A1%E5%BC%8F-%E7%94%9F%E4%BA%A7%E8%80%85"><span class="toc-number">1.3.1.</span> <span class="toc-text">PTP 模式(生产者)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PTP%E6%A8%A1%E5%BC%8F-%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">1.3.2.</span> <span class="toc-text">PTP模式(消费者)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pub-Sub%E6%A8%A1%E5%BC%8F-%E7%94%9F%E6%88%90%E8%80%85"><span class="toc-number">1.3.3.</span> <span class="toc-text">Pub&#x2F;Sub模式(生成者)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pub-Sub%E6%A8%A1%E5%BC%8F-%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">1.3.4.</span> <span class="toc-text">Pub&#x2F;Sub模式(消费者)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Spring%E4%B8%8EActiveMQ%E6%95%B4%E5%90%88"><span class="toc-number">1.4.</span> <span class="toc-text">4.Spring与ActiveMQ整合</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E7%94%9F%E4%BA%A7%E8%80%85"><span class="toc-number">1.4.1.</span> <span class="toc-text">消息生产者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">1.4.2.</span> <span class="toc-text">消息消费者</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-SpringBoot%E4%B8%8EActiveMQ%E6%95%B4%E5%90%88"><span class="toc-number">1.5.</span> <span class="toc-text">5.SpringBoot与ActiveMQ整合</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E7%94%9F%E4%BA%A7%E8%80%85-1"><span class="toc-number">1.5.1.</span> <span class="toc-text">消息生产者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%B6%88%E8%B4%B9%E8%80%85-1"><span class="toc-number">1.5.2.</span> <span class="toc-text">消息消费者</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-ActiveMQ%E6%B6%88%E6%81%AF%E7%BB%84%E6%88%90%E4%B8%8E%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7"><span class="toc-number">1.6.</span> <span class="toc-text">6.ActiveMQ消息组成与高级特性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JMS%E6%B6%88%E6%81%AF%E7%BB%84%E6%88%90%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.6.1.</span> <span class="toc-text">JMS消息组成详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JMS%E6%B6%88%E6%81%AF%E5%A4%B4"><span class="toc-number">1.6.1.1.</span> <span class="toc-text">JMS消息头</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JMS%E6%B6%88%E6%81%AF%E4%BD%93"><span class="toc-number">1.6.1.2.</span> <span class="toc-text">JMS消息体</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JMS%E6%B6%88%E6%81%AF%E5%B1%9E%E6%80%A7"><span class="toc-number">1.6.1.3.</span> <span class="toc-text">JMS消息属性</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.6.2.</span> <span class="toc-text">消息持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6"><span class="toc-number">1.6.2.1.</span> <span class="toc-text">消息确认机制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%8A%95%E9%80%92%E6%96%B9%E5%BC%8F"><span class="toc-number">1.6.3.</span> <span class="toc-text">消息投递方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97"><span class="toc-number">1.6.4.</span> <span class="toc-text">死信队列</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-ActiveMQ%E4%BC%81%E4%B8%9A%E9%9D%A2%E8%AF%95%E7%BB%8F%E5%85%B8%E9%97%AE%E9%A2%98"><span class="toc-number">1.7.</span> <span class="toc-text">7.ActiveMQ企业面试经典问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%EF%BC%9AActiveMQ%E5%AE%95%E6%9C%BA%E4%BA%86%E6%80%8E%E4%B9%88%E5%8A%9E%EF%BC%9F"><span class="toc-number">1.7.1.</span> <span class="toc-text">问题：ActiveMQ宕机了怎么办？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%EF%BC%9A%E5%A6%82%E4%BD%95%E9%98%B2%E6%AD%A2%E6%B6%88%E8%B4%B9%E6%96%B9%E6%B6%88%E6%81%AF%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%EF%BC%9F"><span class="toc-number">1.7.2.</span> <span class="toc-text">问题：如何防止消费方消息重复消费？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%EF%BC%9A%E5%A6%82%E4%BD%95%E9%98%B2%E6%AD%A2%E6%B6%88%E6%81%AF%E4%B8%A2%E5%A4%B1%EF%BC%9F"><span class="toc-number">1.7.3.</span> <span class="toc-text">问题：如何防止消息丢失？</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('https://pic.imgdb.cn/item/60cda4a1844ef46bb2083fc5.png')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By 康小庄</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><div align=center><a href="http://beian.miit.gov.cn/"; target=_blank>苏ICP备2021027330</a></div></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start -->
  <script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/hexo-github-calendar@1.16/hexo_githubcalendar.js"></script>
  <script data-pjax>
        function GithubCalendarConfig(){
            var git_githubapiurl ="https://python-github-calendar-api.vercel.app/api?Kang-xiao-zhuang";
            var git_color =['#ebedf0', '#fdcdec', '#fc9bd9', '#fa6ac5', '#f838b2', '#f5089f', '#c4067e', '#92055e', '#540336', '#48022f', '#30021f'];
            var git_user ="Kang-xiao-zhuang";
            var parent_div_git = document.getElementById('recent-posts');
            var git_div_html = '<div class="recent-post-item" style="width:100%;height:auto;padding:10px;"><div id="github_loading" style="width:10%;height:100%;margin:0 auto;display: block"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animateTransform></path></svg></div><div id="github_container"></div></div>';
            if(parent_div_git && location.pathname =='/'){
                console.log('已挂载github calendar')
                // parent_div_git.innerHTML=git_div_html+parent_div_git.innerHTML // 无报错，但不影响使用(支持pjax跳转)
                parent_div_git.insertAdjacentHTML("afterbegin",git_div_html) // 有报错，但不影响使用(支持pjax跳转)
            };
            GithubCalendar(git_githubapiurl,git_color,git_user)
        }
        if(document.getElementById('recent-posts')){
            GithubCalendarConfig()
        }
    </script>
    <style>#github_container{min-height:280px}@media screen and (max-width:650px) {#github_container{background-image:;min-height:0px}}</style>
    <style>undefined</style><script data-pjax>
  function butterfly_clock_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="https://cdn.jsdelivr.net/gh/tzy13755126023/BLOG_SOURCE/theme_f/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('已挂载butterfly_clock')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_injector_config();
  }
  </script><script src="https://pv.sohu.com/cityjson?ie=utf-8"></script><script data-pjax src="https://cdn.jsdelivr.net/npm/hexo-butterfly-clock/lib/clock.min.js"></script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/Epsilon2.1.model.json"},"display":{"position":"left","width":150,"height":400},"mobile":{"show":false},"rect":"opacity:0.7","log":false,"pluginJsPath":"lib/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>